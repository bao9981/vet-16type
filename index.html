<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¸é†« 16 å‹äººæ ¼æ¸¬é©—</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#e9e9ee;
      --shadow: 0 14px 34px rgba(0,0,0,.08);
      --radius:18px;
      --radius-lg:26px;

      /* âœ… ç»“æœå›¾æœ€å¤§å®½åº¦ï¼ˆæ‰‹æœºä¼šè‡ªåŠ¨ç¼©ï¼‰ */
      --imgMaxW: 320px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",Arial,sans-serif;
      line-height:1.6;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 46px;}
    .topbar{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:26px;letter-spacing:.2px;}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:5px 12px;border:1px solid var(--line);border-radius:999px;
      font-size:12px;color:#333;background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.04);
    }
    .hint{
      margin-top:10px;
      color:#444;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.05);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px;}
    .section{
      margin-top:10px;
      padding:12px 14px;
      border-radius:var(--radius);
      background:#fff;
      border:1px solid var(--line);
      box-shadow:0 10px 24px rgba(0,0,0,.05);
    }
    .section-title{font-weight:900;}
    .small{font-size:13px;color:var(--muted);}

    .q{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.04);
    }
    .q h3{margin:0 0 10px;font-size:16px;font-weight:900;}
    .opt{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:740px){
      .opt{grid-template-columns:1fr;}
    }
    .choice{
      display:flex;gap:10px;align-items:center;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow:0 10px 20px rgba(0,0,0,.04);
      user-select:none;
    }
    .choice:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(0,0,0,.07);}
    .choice input{width:18px;height:18px;accent-color:#111;}
    .choice .label{
      font-weight:800;
      min-width:22px;
    }

    .actions{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;
    }
    button{
      padding:11px 14px;
      border-radius:14px;
      border:1px solid #d7d7dd;
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{
      background:#111;color:#fff;border-color:#111;
      box-shadow:0 14px 30px rgba(0,0,0,.2);
    }
    button:active{transform:translateY(1px);}

    .warn{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #ffd3d7;
      background:#fff4f5;
      color:#b00020;
      display:none;
      font-weight:800;
    }

    .result{
      margin-top:18px;
      padding:16px;
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      background:#fff;
      box-shadow:var(--shadow);
      display:none;
    }

    /* âœ… å·¦å›¾å³æ–‡ï¼›æ‰‹æœºè‡ªåŠ¨æ¢è¡Œï¼Œå¹¶è®©å›¾å±…ä¸­ */
    .result-hero{
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:flex-start;
      flex-wrap:wrap;
    }

    /* âœ… ä½¿ç”¨ <img>ï¼šå½»åº•è§£å†³â€œæˆªåˆ°ä¸‹ä¸€å¼ â€ */
    .type-img{
      width:min(var(--imgMaxW), 90vw);
      height:auto;
      display:block;
      border-radius:28px;
      border:1px solid var(--line);
      box-shadow:0 10px 26px rgba(0,0,0,.06);
      background:#fff;
      margin:0 auto;
    }

    .type-meta{min-width:260px;flex:1;}
    .type-code{font-weight:900;font-size:18px;}
    .type-title{font-size:22px;font-weight:900;margin:8px 0 6px;}
    ul{margin:10px 0 0 20px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .result-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    hr.sep{border:none;border-top:1px solid #eee;margin:16px 0;}

    .scores{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .score-line{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:740px){.two{grid-template-columns:1fr;}}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin-top:8px;}
    .bar>div{height:100%;background:#bbb;width:0%;}

    /* çµ±è¨ˆ */
    .stats{
      margin-top:16px;
      padding:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:#fafafa;
      display:none;
    }
    .stats h4{margin:0 0 8px;font-size:16px;font-weight:900;}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:740px){.stats-grid{grid-template-columns:1fr;}}
    .stat-card{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;}
    .stat-big{font-size:22px;font-weight:900;}
    .rank{margin-top:10px;padding-top:10px;border-top:1px solid var(--line);}
    .rank-item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;}
    .chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 10px;font-size:12px;background:#fff;color:#444;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    select{
      padding:10px 12px;border-radius:14px;border:1px solid #d7d7dd;background:#fff;
      font-weight:800;
    }
    .mini{
      padding:8px 10px;border-radius:12px;border:1px solid #d7d7dd;background:#fff;
      font-weight:800;
      font-size:13px;
    }
    .chart{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .chart-title{font-weight:900;margin-bottom:8px;}
    .dist-item{
      display:grid;
      grid-template-columns: 68px 1fr 54px;
      gap:10px;
      align-items:center;
      padding:6px 0;
    }
    .dist-code{font-weight:900;}
    .dist-bar{
      height:10px;background:#eee;border-radius:999px;overflow:hidden;
    }
    .dist-bar > div{height:100%;background:#bbb;width:0%;}
    .dist-val{text-align:right;font-weight:900;}
    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
    }
    .table th,.table td{
      border-bottom:1px solid #f0f0f3;
      padding:10px 12px;
      text-align:left;
      font-size:13px;
    }
    .table th{background:#fafafa;font-weight:900;}
    .table tr:last-child td{border-bottom:none;}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 12px;border-radius:999px;
      font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s;
    }
    .toast.show{opacity:1;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ç¸é†« 16 å‹äººæ ¼æ¸¬é©—</h1>
        <div class="tag">20 é¡Œï½œ4 æ§‹é¢ï½œäºŒé¸ä¸€ï½œå¯åˆ†äº«å«çœŸå¯¦åˆ†æ•¸</div>
      </div>
    </div>

    <div class="hint" id="topHint">
      ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼ˆA æˆ– Bï¼‰ã€‚<br/>
      çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚<br/>
      åˆ†äº«é€£çµæœƒåŒ…å«çœŸå¯¦åˆ†æ•¸èˆ‡ sig é©—è­‰ï¼Œé¿å…è¢«äº‚æ”¹ã€‚
    </div>

    <div id="quiz" class="grid"></div>

    <div class="actions" id="mainActions">
      <button class="primary" id="btnCalc">è¨ˆç®—çµæœ</button>
      <button id="btnReset">é‡å¡«</button>
    </div>

    <div id="msg" class="warn"></div>

    <div id="result" class="result">
      <div class="result-hero">
        <img id="typeImg" class="type-img" alt="çµæœæ’åœ–" src="" />
        <div class="type-meta">
          <div class="type-code">ä½ çš„å››å­—æ¯ï¼š<span class="mono" id="code"></span></div>
          <div class="type-title" id="typeTitle"></div>
          <div id="typeTrait"></div>
          <div style="margin-top:10px;"><b>ä»£è¡¨å¥ï¼š</b><span id="typeQuote"></span></div>

          <div class="result-actions">
            <button id="btnCopyLink">è¤‡è£½åˆ†äº«é€£çµ</button>
            <button class="primary" id="btnCopyCard">è¤‡è£½çµæœå¡</button>
          </div>

          <div style="margin-top:14px;border-top:1px solid #eee;padding-top:12px;">
            <div style="font-weight:900;margin-bottom:8px;">èº«ä»½ï¼ˆç§‘åˆ¥/è·å‹™ï¼Œç”¨æ–¼äº¤å‰çµ±è¨ˆï¼‰</div>
            <div class="row">
              <select id="identitySelect">
                <option value="">è«‹é¸æ“‡èº«ä»½ï¼ˆå¿…å¡«æ‰èƒ½é€å‡ºçµ±è¨ˆï¼‰</option>
              </select>
              <button class="primary mini" id="btnSubmitStats">é€å‡ºçµ±è¨ˆ</button>
              <button class="mini" id="btnRefreshStats">æ›´æ–°çµ±è¨ˆ</button>
            </div>
            <div class="small" id="identityHint" style="margin-top:8px;">
              å…ˆç®—çµæœï¼Œå†é¸èº«ä»½é€å‡ºçµ±è¨ˆï¼›çµ±è¨ˆç‚ºå…¨é«”å½™ç¸½ã€‚
            </div>
          </div>
        </div>
      </div>

      <hr class="sep" />

      <div style="font-weight:900;margin-bottom:8px;">å„æ§‹é¢åˆ†æ•¸ï¼ˆå«ç¿»ç›¤æç¤ºï¼‰</div>
      <div id="scores" class="scores"></div>

      <div class="stats" id="statsBox">
        <h4>ğŸ“Š å…¨é«”çµæœçµ±è¨ˆ <span class="chip">å·²å•Ÿç”¨</span></h4>
        <div class="small" id="statsHint"></div>

        <div class="stats-grid" style="margin-top:10px;">
          <div class="stat-card">
            <div class="small">ç›®å‰å·²çµ±è¨ˆäººæ¬¡</div>
            <div class="stat-big" id="statsTotal">-</div>
          </div>
          <div class="stat-card">
            <div class="small">ä½ çš„å‹ï¼ˆæ­¤å‹äººæ•¸ï¼‰</div>
            <div class="stat-big" id="statsMine">-</div>
          </div>
        </div>

        <div class="rank" id="statsRank"></div>

        <div class="chart" id="identityChartBox" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="chart-title">èº«ä»½ Ã— 16 å‹åˆ†å¸ƒ</div>
            <div class="row">
              <select id="identityViewSelect"></select>
              <span class="chip" id="identityTopType"></span>
            </div>
          </div>
          <div class="small" id="identityViewHint" style="margin-bottom:8px;"></div>
          <div id="identityDist"></div>
        </div>

        <div class="chart" id="groupDiffBox" style="display:none;">
          <div class="chart-title">é†«å¸« vs åŠ©ç†ï¼šäººæ ¼åˆ†å¸ƒå·®ç•°ï¼ˆTop å·®ç•°ï¼‰</div>
          <div class="small" id="groupDiffHint" style="margin-bottom:8px;"></div>
          <table class="table" id="diffTable">
            <thead>
              <tr>
                <th>äººæ ¼</th>
                <th>é†«å¸«ä½”æ¯”</th>
                <th>åŠ©ç†ä½”æ¯”</th>
                <th>å·®ç•°(é†«å¸«-åŠ©ç†)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast">å·²è¤‡è£½</div>

<script>
/** âœ… åªæ”¹è¿™é‡Œï¼šApps Script Web App /exec */
const STATS_ENDPOINT = "PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE";
/** âœ… å»ºè®®æ”¹æˆéšæœºå­—ç¬¦ä¸² */
const SIG_SALT = "vet-16type-v4::CHANGE_TO_RANDOM";

/** èº«ä»½é€‰é¡¹ï¼ˆå•é€‰ï¼Œä¸åˆå¹¶ï¼‰ */
const IDENTITY_OPTIONS = [
  "å…§ç§‘é†«å¸«","å¤–ç§‘é†«å¸«","å¿ƒè‡Ÿç§‘é†«å¸«","çœ¼ç§‘é†«å¸«","å½±åƒç§‘é†«å¸«","éº»é†‰ç§‘é†«å¸«","ä½é™¢é†«å¸«",
  "é–€è¨ºåŠ©ç†","ä½é™¢éƒ¨åŠ©ç†","å¤–ç§‘åŠ©ç†","è¡Œæ”¿åŠ©ç†","æ«ƒæª¯äººå“¡","è—¥å±€äººå“¡","ç®¡ç†éƒ¨","å¾Œå‹¤äººå“¡",
  "å…¶ä»–ï¼šp.s æ¥Šé›¨è“é†«å¸«æ²’æœ‰æƒ³åˆ°çš„ï¼ˆæ€ªä»–ï¼‰"
];
const GROUP_DOCTOR = new Set(["å…§ç§‘é†«å¸«","å¤–ç§‘é†«å¸«","å¿ƒè‡Ÿç§‘é†«å¸«","çœ¼ç§‘é†«å¸«","å½±åƒç§‘é†«å¸«","éº»é†‰ç§‘é†«å¸«","ä½é™¢é†«å¸«"]);
const GROUP_ASSIST = new Set(["é–€è¨ºåŠ©ç†","ä½é™¢éƒ¨åŠ©ç†","å¤–ç§‘åŠ©ç†","è¡Œæ”¿åŠ©ç†","æ«ƒæª¯äººå“¡","è—¥å±€äººå“¡","ç®¡ç†éƒ¨","å¾Œå‹¤äººå“¡","å…¶ä»–ï¼šp.s æ¥Šé›¨è“é†«å¸«æ²’æœ‰æƒ³åˆ°çš„ï¼ˆæ€ªä»–ï¼‰"]);

const dims = [
  { keyA: "B", keyB: "T", name: "ç¤¾äº¤èƒ½é‡ï¼ˆB / Tï¼‰", param: "bt" },
  { keyA: "P", keyB: "V", name: "å·¥ä½œé¢¨æ ¼ï¼ˆP / Vï¼‰", param: "pv" },
  { keyA: "C", keyB: "D", name: "æ±ºç­–æ¨¡å¼ï¼ˆC / Dï¼‰", param: "cd" },
  { keyA: "O", keyB: "F", name: "æ‡‰è®Šç¯€å¥ï¼ˆO / Fï¼‰", param: "of" },
];

const questions = [
  { dimIndex: 0, text: "Q1ï½œå¿™åˆ°çˆ†ç‚¸çš„ä¸€å¤©çµæŸå¾Œï¼Œä½ æ¯”è¼ƒæƒ³ï¼š", aText: "è·ŸåŒäº‹ä¸€èµ·æŠ±æ€¨ï¼‹å–æš–", bText: "ç«‹åˆ»é€²å…¥çœé›»æ¨¡å¼", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q2ï½œä¼‘æ¯æ™‚é–“ä½ é€šå¸¸ï¼š", aText: "æ‰¾äººä¸€èµ·åƒé£¯èŠå¤©", bText: "ä¸€å€‹äººæ»‘æ‰‹æ©Ÿæ›´èˆ’æœ", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q3ï½œé‡åˆ°æ–°ä¾†çš„äººæ™‚ä½ ï¼š", aText: "ç«‹åˆ»è®Šæˆç†±å¿ƒå‰è¼©", bText: "é»˜é»˜è§€å¯Ÿå†æ±ºå®šè¦ä¸è¦èªªè©±", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q4ï½œé–‹æœƒæ™‚ä½ æ¯”è¼ƒï¼š", aText: "æœƒå¿ä¸ä½æ’è©±è£œå……", bText: "åªåœ¨å¿…è¦æ™‚ç™¼è¨€", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q5ï½œåŒäº‹ç´„ä¸æ˜¯å¤ªç´¯çš„ä½ ä¸‹ç­èšé¤é€šå¸¸ï¼š", aText: "åŸºæœ¬éƒ½æœƒå»", bText: "å¿ƒè£¡å…ˆæƒ³ã€Œæˆ‘åªæƒ³è¶•å¿«å›å®¶...ã€", aKey:"B", bKey:"T" },

  { dimIndex: 1, text: "Q6ï½œé¢å°é™¢å…§å·¥ä½œæ™‚ä½ æ¯”è¼ƒåƒï¼š", aText: "ä¸€å®šæŒ‰ç…§é†«é™¢SOPèµ°", bText: "é ç›´è¦ºæˆ–ç¶“é©—è™•ç†", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q7ï½œå­¸æ–°é€²çš„å„€å™¨/ç³»çµ±æ™‚ä½ ï¼š", aText: "ä¸€å®šè¦æœ‰æ“ä½œæ­¥é©Ÿè¡¨", bText: "æ‘¸ä¸€æ‘¸å°±å¤§æ¦‚æ‡‚äº†", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q8ï½œé¢å°ç—…ä¾‹/æ–‡æ›¸è™•ç†æ™‚ä½ æ¯”è¼ƒåƒï¼š", aText: "æ ¼å¼ä¸€å®šè¦æ•´é½Šæ¼‚äº®", bText: "é‡é»å¯«åˆ°å°±å¥½", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q9ï½œé‡åˆ°è¤‡é›œç‹€æ³ä½ ï¼š", aText: "å…ˆç¿»ç´€éŒ„æˆ–æ˜¯Paperæ‰¾ä¾æ“š", bText: "è…¦ä¸­å…ˆè·‘å¯èƒ½æ€§å†èªª", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q10ï½œä½ æ¯”è¼ƒæ“…é•·ï¼š", aText: "æŠŠä¾‹è¡Œå·¥ä½œåšå¾—å¾ˆç©©", bText: "è™•ç†çªç™¼å¥‡æ€ªæ¡ˆä»¶", aKey:"P", bKey:"V" },

  { dimIndex: 2, text: "Q11ï½œé‡åˆ°é†«ç™‚ç³¾ç´›æ™‚ä½ å…ˆæƒ³ï¼š", aText: "æ˜¯å¦æ˜¯å°ˆæ¥­çš„å•é¡Œï¼Œå°éŒ¯åœ¨å“ª", bText: "ä¸»äººç¾åœ¨çš„æƒ…ç·’å¾ˆç·Šç¹ƒï¼Œæˆ‘è¦æ€éº¼å®‰æ’«ä¸»äºº", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q12ï½œåŒäº‹å‡ºåŒ…æ™‚ä½ æœƒï¼š", aText: "å…ˆè¬›é‡é»æ€éº¼ä¿®æ­£", bText: "å…ˆèªªã€Œæ²’äº‹æ²’äº‹ã€", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q13ï½œå®‰æ’«æƒ…ç·’èµ·ä¼è¼ƒå¤§çš„ä¸»äºº/åŒäº‹ä½ æ¯”è¼ƒåƒï¼š", aText: "èªªæ˜é¢¨éšªèˆ‡ç¾æ³", bText: "ç”¨èªæ°£è·Ÿæ…‹åº¦å®‰æ’«", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q14ï½œåšæ±ºå®šæ™‚ä½ ï¼š", aText: "ç”¨è…¦è¢‹åˆ†æ", bText: "ç”¨å¿ƒæ„Ÿè¦º", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q15ï½œä½ æ›´åœ¨æ„ï¼š", aText: "æŠŠäº‹æƒ…åšå°", bText: "ä¸è¦å‚·æ„Ÿæƒ…", aKey:"C", bKey:"D" },

  { dimIndex: 3, text: "Q16ï½œç­è¡¨è¢«è‡¨æ™‚æ›´å‹•æ™‚ä½ ï¼š", aText: "å…§å¿ƒæœƒå°å´©æ½°", bText: "è¦ºå¾—ã€Œå¥½å–”OKã€", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q17ï½œæ¯å¤©å·¥ä½œä½ åå¥½ï¼š", aText: "å…ˆæ’å¥½é †åºå†åš", bText: "ä¾†ä¸Šç­ä¹‹å¾Œï¼Œæœ‰ä»€éº¼åšä»€éº¼", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q18ï½œç•¶å¤©å·¥ä½œæœªå®Œæˆï¼ˆå¦‚è£œç—…æ­·ã€è£œè€—æï¼‰ä½ é€šå¸¸ï¼š", aText: "ç•¶å¤©ä¸€å®šæ¸…å®Œ", bText: "ç›¸ä¿¡æ˜å¤©çš„æˆ‘æœƒè¨˜å¾—è™•ç†", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q19ï½œé‡åˆ°è‡¨æ™‚åŠ è™Ÿ/é€²åº¦DELAYçš„ä½ ï¼š", aText: "é‚„æˆ‘è¨ˆç•«ï¼Œå¿ƒè£¡OSå¾ˆå¤š", bText: "å½ˆæ€§äººç”Ÿï¼Œç›´æ¥åšå°±å°äº†", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q20ï½œè‡¨æ™‚æœ‰åŒäº‹è«‹å‡éœ€è¦æ”¯æ´æ™‚ä½ ï¼š", aText: "æœƒå¸Œæœ›æå‰çŸ¥é“èˆ‡å®‰æ’", bText: "ç¾å ´éœ€è¦å°±ç›´æ¥ä¸Šï¼Œæœ‰éŒ¢ä¸è³ºï¼Œç‹å…«è›‹", aKey:"O", bKey:"F" },
];

const typeMap = {
  "BPCO": { title:"ğŸ¶ã€å¾·åœ‹ç‰§ç¾ŠçŠ¬å‹ã€‘", trait:["ç´€å¾‹æ”¯æŸ±å‹","é‡æµç¨‹ã€è¬›æ•ˆç‡","åœ˜éšŠæ ¸å¿ƒäººç‰©"], quote:"ã€Œäº¤çµ¦æˆ‘ï¼Œæˆ‘è™•ç†ã€‚ã€" },
  "BPCF": { title:"ğŸ•ã€ç±³æ ¼é­¯å‹ã€‘", trait:["æ´»åŠ›åŸ·è¡Œè€…","ç†±å¿ƒåˆå‹™å¯¦","åšäº‹æœ‰æ•ˆç‡"], quote:"ã€Œé‚Šåšé‚Šèª¿æ•´ï¼ã€" },
  "BPDO": { title:"ğŸ•ã€é»ƒé‡‘çµçŠ¬å‹ã€‘", trait:["æš–å¿ƒè¡Œå‹•æ´¾","ç†±æƒ…åˆè² è²¬","ä¾†çœ‹è¨ºçš„éƒ½å®‰å¿ƒ"], quote:"ã€Œæˆ‘æ‡‚ä½ ï¼Œæˆ‘ä¾†å¹«å¿™ã€‚ã€" },
  "BPDF": { title:"ğŸ•ã€æŸ¯åŸºå‹ã€‘", trait:["è¦ªåˆ‡å¯¦å‹™å‹","å¯æ„›åˆå¥½ç›¸è™•","åšäº‹æ¥åœ°æ°£"], quote:"ã€Œæˆ‘ä¾†æ¨å‹•ä»»å‹™é€²å±•~ã€‚ã€" },

  "BVCO": { title:"ğŸ±ã€è™æ–‘è²“å‹ã€‘", trait:["ç­–ç•¥é ˜å°å‹","ç›´è¦ºå¼·","å–„æ–¼è¦åŠƒ"], quote:"ã€Œè®“æˆ‘æƒ³ä¸€ä¸‹å…¨å±€ã€‚ã€" },
  "BVCF": { title:"ğŸ±ã€è±¹è²“å‹ã€‘", trait:["æ©Ÿå‹•æ•‘ç«éšŠ","æ©Ÿéˆé€Ÿæ±º","éˆæ´»åˆç†æ€§"], quote:"ã€Œçªç™¼ï¼Ÿæˆ‘OKã€‚ã€" },
  "BVDO": { title:"ğŸ¶ã€é‚Šå¢ƒç‰§ç¾ŠçŠ¬å‹ã€‘", trait:["ç†±è¡€é ˜éšŠå‹","ä½èª¿ç©©å®š","æœ‰æƒ³æ³•åˆè²¼å¿ƒ"], quote:"ã€Œè®“æˆ‘å€‘ä¸€èµ·æå®šï¼ã€" },
  "BVDF": { title:"ğŸ¶ã€å“ˆå£«å¥‡å‹ã€‘", trait:["æ°£æ°›ç‹è€…","åœ˜éšŠé–‹å¿ƒæœ","éˆæ´»é©æ‡‰"], quote:"ã€Œæˆ‘ä¾†ï¼Œæˆ‘ä¾†ï¼ã€" },

  "TPCO": { title:"ğŸ±ã€ç·¬å› è²“å‹ã€‘", trait:["å†·éœå°ˆæ¥­æ´¾","ç©©å®šå¯é ","å°ˆæ³¨åš´è¬¹"], quote:"ã€Œå…ˆæŒ‰SOPèµ°ã€‚ã€" },
  "TPCF": { title:"ğŸ±ã€æ–¯èŠ¬å…‹æ–¯è²“å‹ã€‘", trait:["ä½èª¿æ•ˆç‡å‹","è§€å¯Ÿæ•éŠ³","å®‰éœä½†å¼·"], quote:"ã€Œé»˜é»˜æŠŠäº‹åšå¥½ã€‚ã€" },
  "TPDO": { title:"ğŸ¶ã€å–œæ¨‚è’‚å‹ã€‘", trait:["æº«å’Œå¯¦å¹¹æ´¾","ç©©å¥åšäº‹","å®ˆè­·èˆ’é©æ°›åœ"], quote:"ã€Œä¸€æ­¥ä¸€æ­¥ä¾†ã€‚ã€" },
  "TPDF": { title:"ğŸ¶ã€æ‹‰ä¸æ‹‰å¤šå‹ã€‘", trait:["ä½›ç³»æš–å¿ƒå‹","æº«æš–æ´»æ½‘","æ¨‚æ–¼åˆ†äº«"], quote:"ã€Œå¤§å®¶éƒ½è¾›è‹¦äº†ã€‚ã€" },

  "TVCO": { title:"ğŸ±ã€æŒªå¨æ£®æ—è²“å‹ã€‘", trait:["åˆ†æç­–ç•¥å‹","æ¨ç†åš´å¯†","ä»”ç´°åˆ†æ"], quote:"ã€Œæˆ‘å…ˆç ”ç©¶ä¸€ä¸‹ã€‚ã€" },
  "TVCF": { title:"ğŸ±ã€æš¹ç¾…è²“å‹ã€‘", trait:["å†·éœå½ˆæ€§å‹","åæ‡‰å¿«é€Ÿ","å‰µæ–°è¡Œå‹•"], quote:"ã€Œéš¨æ©Ÿæ‡‰è®Šã€‚ã€" },
  "TVDO": { title:"ğŸ¶ã€ä¼¯æ©å±±å‹ã€‘", trait:["å…§æ–‚é ˜å°è€…","å½ˆæ€§å‹™å¯¦","é—œæ‡·å‚™è‡³"], quote:"ã€Œç©©ç©©åœ°åšå°±å¥½ã€‚ã€" },
  "TVDF": { title:"ğŸ¶ã€å¤§ç™½ç†Šå‹ã€‘", trait:["æº«æŸ”æ™ºè€…å‹","é‡è¦–æº«åº¦","æƒ…æ„Ÿè±å¯Œ"], quote:"ã€Œæ²’äº‹ï¼Œæˆ‘é™ªä½ ã€‚ã€" },
};

const typeOrder = [
  "BPCO","BPCF","BPDO","BPDF",
  "BVCO","BVCF","BVDO","BVDF",
  "TPCO","TPCF","TPDO","TPDF",
  "TVCO","TVCF","TVDO","TVDF"
];

/** ======== sig é˜²ä¹±æ”¹ï¼ˆSHA-256ï¼‰ ======== */
function canonicalString(code, paramsObj) {
  return `r=${code}&bt=${paramsObj.bt}&pv=${paramsObj.pv}&cd=${paramsObj.cd}&of=${paramsObj.of}&salt=${SIG_SALT}`;
}
async function sha256Hex(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
}
async function makeSig(code, pairs) {
  const hex = await sha256Hex(canonicalString(code, pairs));
  return hex.slice(0,16);
}

/** ======== utils ======== */
function toast(text){
  const t=document.getElementById("toast");
  t.textContent=text;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); toast("å·²è¤‡è£½ âœ…"); }
  catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand("copy"); document.body.removeChild(ta);
    toast("å·²è¤‡è£½ âœ…");
  }
}
function showMsg(t){
  const msg=document.getElementById("msg");
  msg.style.display="block"; msg.textContent=t;
}
function hideMsg(){
  const msg=document.getElementById("msg");
  msg.style.display="none"; msg.textContent="";
}
function flipHint(aKey,aScore,bKey,bScore){
  const diff=Math.abs(aScore-bScore);
  const need=Math.floor(diff/2)+1;
  const leader=aScore>bScore?aKey:bKey;
  return `ç›®å‰ ${leader} é ˜å…ˆï½œå·® ${need} é¡Œç¿»ç›¤`;
}
function encodePair(a,b){ return `${a}-${b}`; }
function decodePair(str){
  if(!/^\d-\d$/.test(str)) return null;
  const [a,b]=str.split("-").map(n=>parseInt(n,10));
  if([a,b].some(n=>Number.isNaN(n)||n<0||n>5)) return null;
  if(a+b!==5) return null;
  if(a===b) return null;
  return {a,b};
}
function normalizeTypeCode(s){
  return (s||"").toUpperCase().trim();
}
function typeImagePath(code){
  return `images/${code}.jpg`;
}
function setTypeImage(code){
  const img=document.getElementById("typeImg");
  img.src = typeImagePath(code);
  img.onerror = ()=>{ img.removeAttribute("src"); img.alt="æ‰¾ä¸åˆ°åœ–ç‰‡ï¼šimages/"+code+".jpg"; };
}

/** ======== render quiz ======== */
function renderQuiz(){
  const root=document.getElementById("quiz");
  root.innerHTML="";
  dims.forEach((d,dimIndex)=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML=`
      <div class="section-title">ğŸ§© ${d.name}</div>
      <div class="small">æ­¤æ§‹é¢ï¼š${d.keyA} vs ${d.keyB}ï¼ˆå…± 5 é¡Œï¼‰</div>
    `;
    root.appendChild(sec);

    questions
      .map((q,idx)=>({q,idx}))
      .filter(x=>x.q.dimIndex===dimIndex)
      .forEach(({q,idx})=>{
        const qId=`q${idx}`;
        const div=document.createElement("div");
        div.className="q";
        div.innerHTML=`
          <h3>${q.text}</h3>
          <div class="opt">
            <label class="choice">
              <input type="radio" name="${qId}" value="A" />
              <span class="label">A</span>
              <span>${q.aText}</span>
            </label>
            <label class="choice">
              <input type="radio" name="${qId}" value="B" />
              <span class="label">B</span>
              <span>${q.bText}</span>
            </label>
          </div>
        `;
        root.appendChild(div);
      });
  });
}
function getAnswers(){
  return questions.map((_,i)=>document.querySelector(`input[name="q${i}"]:checked`)?.value || null);
}

/** ======== compute / share ======== */
function computeFromAnswers(answers){
  const score={B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0};
  answers.forEach((ans,i)=>{
    const q=questions[i];
    const key=(ans==="A")?q.aKey:q.bKey;
    score[key]+=1;
  });
  const letters=dims.map(d=>score[d.keyA]>score[d.keyB]?d.keyA:d.keyB);
  const code=letters.join("");
  const pairs={};
  dims.forEach(d=>pairs[d.param]=encodePair(score[d.keyA],score[d.keyB]));
  return {score,code,pairs};
}
async function setShareParamsWithSig({code,pairs}){
  const sig=await makeSig(code,pairs);
  const url=new URL(window.location.href);
  url.searchParams.set("r",code);
  dims.forEach(d=>url.searchParams.set(d.param,pairs[d.param]));
  url.searchParams.set("sig",sig);
  window.history.replaceState({}, "", url.toString());
}

/** ======== render result ======== */
function renderResult({score,code}){
  const info=typeMap[code] || {title:"æœªå®šç¾©çµæœ",trait:["è«‹è£œä¸Š typeMap"],quote:""};
  document.getElementById("code").textContent=code;
  document.getElementById("typeTitle").textContent=info.title;

  setTypeImage(code);

  const traitHTML=Array.isArray(info.trait)
    ? `<ul>${info.trait.map(t=>`<li>${t}</li>`).join("")}</ul>`
    : `<div>${info.trait}</div>`;
  document.getElementById("typeTrait").innerHTML=traitHTML;
  document.getElementById("typeQuote").textContent=info.quote || "";

  const scoresBox=document.getElementById("scores");
  scoresBox.innerHTML="";
  dims.forEach(d=>{
    const a=score[d.keyA], b=score[d.keyB];
    const winner=a>b?d.keyA:d.keyB;
    const card=document.createElement("div");
    card.className="score-line";
    const pct=(a/5)*100;
    card.innerHTML=`
      <div style="font-weight:900;">${d.name}</div>
      <div class="two">
        <div>${d.keyA}ï¼š<span class="mono">${a}</span></div>
        <div>${d.keyB}ï¼š<span class="mono">${b}</span></div>
      </div>
      <div class="small">
        çµæœï¼š<b>${winner}</b> ï½œ <span class="mono">${d.keyA} ${a} / ${d.keyB} ${b}</span> ï½œ ${flipHint(d.keyA,a,d.keyB,b)}
      </div>
      <div class="bar"><div style="width:${pct}%"></div></div>
      <div class="small">é•·æ¢ç‚º ${d.keyA} ä½”æ¯”ï¼ˆ0~5ï¼‰</div>
    `;
    scoresBox.appendChild(card);
  });

  document.getElementById("result").style.display="block";
}
function buildResultCardText({score,code}){
  const info=typeMap[code] || {title:"æœªå®šç¾©çµæœ",trait:[],quote:""};
  const url=window.location.href;
  const dimLines=dims.map(d=>{
    const a=score[d.keyA], b=score[d.keyB];
    const winner=a>b?d.keyA:d.keyB;
    return `- ${d.name}ï¼š${d.keyA} ${a} / ${d.keyB} ${b} â†’ ${winner}ï¼ˆ${flipHint(d.keyA,a,d.keyB,b)}ï¼‰`;
  }).join("\n");
  const traits=Array.isArray(info.trait) && info.trait.length ? info.trait.map(t=>`- ${t}`).join("\n") : "";
  return [
    `ã€ç¸é†« 16 å‹äººæ ¼æ¸¬é©—çµæœã€‘`,
    `å››å­—æ¯ï¼š${code}`,
    `${info.title}`,
    traits ? `\nç‰¹è³ªï¼š\n${traits}` : "",
    info.quote ? `\nä»£è¡¨å¥ï¼š${info.quote}` : "",
    `\næ§‹é¢åˆ†æ•¸ï¼š\n${dimLines}`,
    `\nåˆ†äº«é€£çµï¼ˆå«çœŸå¯¦åˆ†æ•¸+é©—è­‰ï¼‰ï¼š${url}`
  ].filter(Boolean).join("\n");
}

/** ======== stats: POST / GETï¼ˆé¿å… CORS é¢„æ£€ï¼‰ ======== */
async function sendStatsRecord(payload){
  if(!STATS_ENDPOINT || STATS_ENDPOINT.startsWith("PASTE_")) return {ok:false, err:"NO_ENDPOINT"};
  try{
    await fetch(STATS_ENDPOINT, { method:"POST", body: JSON.stringify(payload) });
    return {ok:true};
  }catch(e){
    return {ok:false, err:String(e)};
  }
}
async function loadStats(){
  if(!STATS_ENDPOINT || STATS_ENDPOINT.startsWith("PASTE_")) return null;
  try{
    const res=await fetch(STATS_ENDPOINT, { method:"GET" });
    return await res.json();
  }catch(e){
    return null;
  }
}

/** ======== render stats ======== */
function renderRank(countsByType){
  const entries=Object.entries(countsByType||{}).sort((a,b)=>b[1]-a[1]);
  const total=entries.reduce((s,[,v])=>s+v,0);
  const url=new URL(window.location.href);
  const myCode=normalizeTypeCode(url.searchParams.get("r"));

  document.getElementById("statsBox").style.display="block";
  document.getElementById("statsHint").textContent="ï¼ˆæ­¤çµ±è¨ˆç‚ºå…¨é«”ä½œç­”è€…å½™ç¸½ï¼Œåˆ·æ–°é é¢å¯æ›´æ–°ï¼‰";
  document.getElementById("statsTotal").textContent=`${total}`;
  document.getElementById("statsMine").textContent = myCode ? `${myCode}ï¼š${(countsByType||{})[myCode]||0}` : "-";

  const rankBox=document.getElementById("statsRank");
  rankBox.innerHTML=`<div style="font-weight:900;margin-bottom:6px;">æ’è¡Œæ¦œï¼ˆå‰ 8ï¼‰</div>`;
  const top=entries.slice(0,8);
  if(!top.length){ rankBox.innerHTML+=`<div class="small">å°šç„¡è³‡æ–™</div>`; return; }
  top.forEach(([k,v],i)=>{
    const row=document.createElement("div");
    row.className="rank-item";
    row.innerHTML=`<div>${i+1}. <span class="mono">${k}</span></div><div><b>${v}</b></div>`;
    rankBox.appendChild(row);
  });
}

function buildDistributionRow(code, v, max){
  const div=document.createElement("div");
  div.className="dist-item";
  div.innerHTML=`
    <div class="dist-code mono">${code}</div>
    <div class="dist-bar"><div style="width:${max? (v/max)*100 : 0}%"></div></div>
    <div class="dist-val">${v}</div>
  `;
  return div;
}

function renderIdentityDist(stats){
  const sel=document.getElementById("identityViewSelect");
  const box=document.getElementById("identityChartBox");
  const dist=document.getElementById("identityDist");
  const topChip=document.getElementById("identityTopType");
  const hint=document.getElementById("identityViewHint");

  const countsByIdentity = stats?.countsByIdentity || {};
  const countsByIdentityType = stats?.countsByIdentityType || {};

  const identities = Object.keys(countsByIdentity).sort((a,b)=> (countsByIdentity[b]||0)-(countsByIdentity[a]||0));
  if(!identities.length){
    box.style.display="none";
    return;
  }
  box.style.display="block";

  // åˆå§‹åŒ–ä¸‹æ‹‰ï¼ˆä¸è¦†ç›–ç”¨æˆ·é€‰æ‹©ï¼‰
  const current = sel.value || identities[0];
  sel.innerHTML = "";
  identities.forEach(id=>{
    const opt=document.createElement("option");
    opt.value=id;
    opt.textContent = `${id}ï¼ˆ${countsByIdentity[id]||0}ï¼‰`;
    sel.appendChild(opt);
  });
  sel.value = identities.includes(current) ? current : identities[0];

  const id = sel.value;
  const map = countsByIdentityType[id] || {};
  const entries = typeOrder.map(t=>[t, map[t]||0]);
  const max = Math.max(...entries.map(([,v])=>v), 1);
  const total = entries.reduce((s,[,v])=>s+v,0);

  // Top type
  const top = entries.slice().sort((a,b)=>b[1]-a[1])[0];
  topChip.textContent = top && top[1]>0 ? `æœ€å¸¸è¦‹ï¼š${top[0]}ï¼ˆ${top[1]} / ${total}ï¼‰` : "å°šç„¡è³‡æ–™";
  hint.textContent = `é¡¯ç¤ºã€Œ${id}ã€çš„ 16 å‹åˆ†å¸ƒï¼ˆç¸½æ¨£æœ¬ï¼š${total}ï¼‰`;

  dist.innerHTML="";
  entries
    .slice()
    .sort((a,b)=>b[1]-a[1])
    .forEach(([t,v])=> dist.appendChild(buildDistributionRow(t,v,max)));

  sel.onchange = ()=>renderIdentityDist(stats);
}

function pct(n){ return (Math.round(n*1000)/10).toFixed(1)+"%"; }

function renderGroupDiff(stats){
  const box=document.getElementById("groupDiffBox");
  const hint=document.getElementById("groupDiffHint");
  const tbody=document.querySelector("#diffTable tbody");

  const g = stats?.countsByGroupType || {};
  const doc = g["doctor"] || {};
  const asst = g["assist"] || {};

  const docTotal = Object.values(doc).reduce((s,v)=>s+v,0);
  const asstTotal = Object.values(asst).reduce((s,v)=>s+v,0);

  if(docTotal===0 && asstTotal===0){
    box.style.display="none";
    return;
  }
  box.style.display="block";
  hint.textContent = `é†«å¸«æ¨£æœ¬ï¼š${docTotal}ï½œåŠ©ç†æ¨£æœ¬ï¼š${asstTotal}ï¼ˆç”¨ä½ å®šç¾©çš„èº«ä»½åˆ†çµ„ï¼‰`;

  const rows = typeOrder.map(t=>{
    const d = docTotal ? (doc[t]||0)/docTotal : 0;
    const a = asstTotal ? (asst[t]||0)/asstTotal : 0;
    return { t, d, a, diff: d-a };
  }).sort((x,y)=> Math.abs(y.diff)-Math.abs(x.diff)).slice(0,8);

  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${r.t}</td>
      <td>${pct(r.d)}</td>
      <td>${pct(r.a)}</td>
      <td><b>${pct(r.diff)}</b></td>
    `;
    tbody.appendChild(tr);
  });
}

async function refreshStatsUI(){
  const stats = await loadStats();
  if(!stats || !stats.ok){
    document.getElementById("statsBox").style.display="block";
    document.getElementById("statsHint").textContent="ï¼ˆçµ±è¨ˆè®€å–å¤±æ•—ï¼šè«‹ç¢ºèª Apps Script Web App å·²éƒ¨ç½²ä¸”å¯åŒ¿åå­˜å–ï¼‰";
    return;
  }
  renderRank(stats.countsByType || {});
  renderIdentityDist(stats);
  renderGroupDiff(stats);
}

/** ======== main flow ======== */
let lastComputed = null;

async function calcFromUI(){
  hideMsg();
  const answers=getAnswers();
  const missing=answers.map((v,i)=>v?null:i+1).filter(Boolean);
  if(missing.length){
    showMsg(`ä½ é‚„æœ‰ ${missing.length} é¡Œæœªä½œç­”ï¼šç¬¬ ${missing.join(", ")} é¡Œ`);
    return;
  }

  const computed=computeFromAnswers(answers);
  lastComputed = computed;

  await setShareParamsWithSig({code:computed.code,pairs:computed.pairs});
  renderResult({score:computed.score,code:computed.code});

  // åªåˆ·æ–°ç»Ÿè®¡ï¼ˆä¸è‡ªåŠ¨é€å‡ºï¼›é¿å…æ²¡é€‰èº«ä»½å°±äº§ç”Ÿè„æ•°æ®ï¼‰
  await refreshStatsUI();

  document.getElementById("result").scrollIntoView({behavior:"smooth"});
}

function resetAll(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.getElementById("result").style.display="none";
  hideMsg();
  lastComputed = null;

  const url=new URL(window.location.href);
  ["r","sig",...dims.map(d=>d.param)].forEach(k=>url.searchParams.delete(k));
  window.history.replaceState({}, "", url.toString());

  document.getElementById("mainActions").style.display="";
  document.getElementById("topHint").innerHTML=
    `ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼ˆA æˆ– Bï¼‰ã€‚<br/>
     çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚<br/>
     åˆ†äº«é€£çµæœƒåŒ…å«çœŸå¯¦åˆ†æ•¸èˆ‡ sig é©—è­‰ï¼Œé¿å…è¢«äº‚æ”¹ã€‚`;
  document.getElementById("statsBox").style.display="none";
  window.scrollTo({top:0,behavior:"smooth"});
}

/** ======== share link read (sig verify) ======== */
async function showResultFromParamsIfAny(){
  const url=new URL(window.location.href);
  const r=normalizeTypeCode(url.searchParams.get("r"));
  if(!r) return;

  const codeOk=/^[BT][PV][CD][OF]$/.test(r) && typeMap[r];
  if(!codeOk) return;

  const sig=(url.searchParams.get("sig")||"").trim();
  if(!sig){ showMsg("æ­¤åˆ†äº«é€£çµç¼ºå°‘é©—è­‰ç¢¼ï¼ˆsigï¼‰ï¼Œå¯èƒ½å·²è¢«ä¿®æ”¹æˆ–ç‰ˆæœ¬éèˆŠã€‚"); return; }

  const pairs={};
  const score={B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0};

  for(const d of dims){
    const raw=(url.searchParams.get(d.param)||"").trim();
    const pair=decodePair(raw);
    if(!pair){ showMsg("æ­¤åˆ†äº«é€£çµçš„åˆ†æ•¸åƒæ•¸ä¸å®Œæ•´æˆ–ä¸åˆæ³•ï¼ˆéœ€ç‚º 5 é¡Œåˆ¶ï¼Œä¾‹å¦‚ 4-1ï¼‰ã€‚"); return; }
    pairs[d.param]=raw;
    score[d.keyA]=pair.a;
    score[d.keyB]=pair.b;

    const winner=(pair.a>pair.b)?d.keyA:d.keyB;
    const expected=r[dims.indexOf(d)];
    if(winner!==expected){ showMsg("åˆ†äº«é€£çµçš„ r èˆ‡åˆ†æ•¸å‹è² ä¸ä¸€è‡´ï¼Œå¯èƒ½è¢«æ‰‹å‹•ä¿®æ”¹ã€‚"); return; }
  }

  const expectedSig=await makeSig(r,pairs);
  if(expectedSig!==sig){ showMsg("æ­¤åˆ†äº«é€£çµå·²è¢«ä¿®æ”¹ï¼ˆsig é©—è­‰å¤±æ•—ï¼‰ã€‚è«‹é‡æ–°ç”¢ç”Ÿåˆ†äº«é€£çµã€‚"); return; }

  document.getElementById("topHint").innerHTML=
    `ä½ æ­£åœ¨æŸ¥çœ‹åˆ†äº«çµæœï¼š<span class="mono">${r}</span>ï¼ˆæ­¤é€£çµåŒ…å«çœŸå¯¦åˆ†æ•¸ï¼Œä¸”å·²é€šéé©—è­‰ï¼‰`;
  document.getElementById("mainActions").style.display="none";

  renderResult({score,code:r});
  await refreshStatsUI();

  document.getElementById("result").scrollIntoView({behavior:"smooth"});
}

/** ======== identity select init ======== */
function initIdentitySelects(){
  const sel=document.getElementById("identitySelect");
  IDENTITY_OPTIONS.forEach(v=>{
    const opt=document.createElement("option");
    opt.value=v;
    opt.textContent=v;
    sel.appendChild(opt);
  });
}

/** ======== submit stats (needs identity) ======== */
async function submitStatsWithIdentity(){
  hideMsg();
  if(!lastComputed){
    showMsg("è«‹å…ˆå®Œæˆ 20 é¡Œä¸¦æŒ‰ã€Œè¨ˆç®—çµæœã€ã€‚");
    return;
  }
  const identity=document.getElementById("identitySelect").value;
  if(!identity){
    showMsg("è«‹å…ˆé¸æ“‡èº«ä»½ï¼ˆç§‘åˆ¥/è·å‹™ï¼‰ï¼Œå†é€å‡ºçµ±è¨ˆã€‚");
    return;
  }

  const payload = {
    type: lastComputed.code,
    r: lastComputed.code,
    bt: lastComputed.pairs.bt,
    pv: lastComputed.pairs.pv,
    cd: lastComputed.pairs.cd,
    of: lastComputed.pairs.of,
    identity,
    ua: navigator.userAgent,
  };

  const post = await sendStatsRecord(payload);
  if(!post.ok){
    showMsg("çµ±è¨ˆé€å‡ºå¤±æ•—ï¼šè«‹ç¢ºèª Apps Script å·²éƒ¨ç½²ç‚º Web App ä¸¦å…è¨±åŒ¿åå­˜å–ã€‚");
    return;
  }
  toast("å·²é€å‡ºçµ±è¨ˆ âœ…");
  await refreshStatsUI();
}

/** ======== init ======== */
renderQuiz();
initIdentitySelects();
showResultFromParamsIfAny();

document.getElementById("btnCalc").addEventListener("click", calcFromUI);
document.getElementById("btnReset").addEventListener("click", resetAll);

document.getElementById("btnCopyLink").addEventListener("click", ()=>{
  hideMsg();
  const url=new URL(window.location.href);
  const hasR=url.searchParams.get("r");
  const hasSig=url.searchParams.get("sig");
  if(!hasR || !hasSig){ showMsg("è«‹å…ˆå®Œæˆ 20 é¡Œä¸¦æŒ‰ã€Œè¨ˆç®—çµæœã€ï¼Œæ‰æœƒç”¢ç”Ÿå¯åˆ†äº«çš„é€£çµï¼ˆå« sigï¼‰ã€‚"); return; }
  copyText(window.location.href);
});

document.getElementById("btnCopyCard").addEventListener("click", async ()=>{
  hideMsg();
  const url=new URL(window.location.href);
  const r=normalizeTypeCode(url.searchParams.get("r"));
  const sig=(url.searchParams.get("sig")||"").trim();

  if(r && typeMap[r] && sig){
    const pairs={};
    const score={B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0};
    for(const d of dims){
      const raw=(url.searchParams.get(d.param)||"").trim();
      const pair=decodePair(raw);
      if(!pair){ showMsg("ç›®å‰ç¶²å€ç¼ºå°‘å®Œæ•´åˆ†æ•¸åƒæ•¸ï¼Œè«‹é‡æ–°è¨ˆç®—çµæœå¾Œå†è¤‡è£½çµæœå¡ã€‚"); return; }
      pairs[d.param]=raw;
      score[d.keyA]=pair.a;
      score[d.keyB]=pair.b;
    }
    const expectedSig=await makeSig(r,pairs);
    if(expectedSig!==sig){ showMsg("ç›®å‰ç¶²å€çš„ sig é©—è­‰å¤±æ•—ï¼ˆå¯èƒ½è¢«æ”¹éï¼‰ã€‚è«‹é‡æ–°è¨ˆç®—çµæœç”¢ç”Ÿæ–°é€£çµã€‚"); return; }
    copyText(buildResultCardText({score,code:r}));
    return;
  }

  if(!lastComputed){
    showMsg("è¦è¤‡è£½çµæœå¡å‰ï¼Œè«‹å…ˆå®Œæˆ 20 é¡Œä¸¦è¨ˆç®—çµæœã€‚");
    return;
  }
  await setShareParamsWithSig({code:lastComputed.code,pairs:lastComputed.pairs});
  renderResult({score:lastComputed.score,code:lastComputed.code});
  copyText(buildResultCardText({score:lastComputed.score,code:lastComputed.code}));
});

document.getElementById("btnSubmitStats").addEventListener("click", submitStatsWithIdentity);
document.getElementById("btnRefreshStats").addEventListener("click", refreshStatsUI);
</script>
</body>
</html>
