<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¸é†« 16 å‹äººæ ¼æ¸¬é©—</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.6; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 8px; font-size: 26px; }
    .hint { color: #555; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .q { border: 1px solid #ddd; border-radius: 12px; padding: 14px 14px 10px; }
    .q h3 { margin: 0 0 10px; font-size: 16px; }
    .opt { display: flex; gap: 14px; flex-wrap: wrap; }
    label { display: inline-flex; gap: 8px; align-items: center; cursor: pointer; }
    .small { font-size: 13px; color: #666; }
    .section { margin: 18px 0 10px; padding: 10px 12px; border-radius: 12px; background: #fafafa; border: 1px solid #eee; }
    .section-title { font-weight: 700; }
    .actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { border-color: #111; background: #111; color: #fff; }
    .warn { color: #b00020; margin-top: 10px; display:none; }
    .result { margin-top: 22px; padding: 16px; border: 1px solid #ddd; border-radius: 14px; background: #fafafa; display:none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .tag { display:inline-block; padding: 2px 10px; border: 1px solid #ddd; border-radius: 999px; margin-left: 8px; font-size: 12px; color:#444; background:#fff; }
    .type-title { font-size: 20px; font-weight: 800; margin: 6px 0 10px; }
    ul { margin: 8px 0 0 20px; }
    .scores { display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .score-line { padding: 10px 12px; border-radius: 12px; border: 1px solid #e6e6e6; background:#fff; }
    .bar { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .bar > div { height: 100%; width: 50%; background: #bbb; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .result-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius: 999px; font-size: 13px; opacity:0; pointer-events:none; transition: opacity .2s; }
    .toast.show { opacity:1; }
    @media (max-width: 740px) { .two { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ç¸é†« 16 å‹äººæ ¼æ¸¬é©— <span class="tag">20 é¡Œï½œ4 æ§‹é¢ï½œäºŒé¸ä¸€</span></h1>
  <div class="hint" id="topHint">
    ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼›è©²é¸é …å°æ‡‰çš„å­—æ¯ +1ã€‚<br/>
    çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚
  </div>

  <div id="quiz" class="grid"></div>

  <div class="actions" id="mainActions">
    <button class="primary" id="btnCalc">è¨ˆç®—çµæœ</button>
    <button id="btnReset">é‡å¡«</button>
  </div>

  <div id="msg" class="warn"></div>

  <div id="result" class="result">
    <div>ä½ çš„å››å­—æ¯ï¼š<span class="mono" id="code"></span></div>
    <div class="type-title" id="typeTitle"></div>
    <div id="typeTrait"></div>
    <div style="margin-top:10px;"><b>ä»£è¡¨å¥ï¼š</b><span id="typeQuote"></span></div>

    <div class="result-actions">
      <button id="btnCopyLink">è¤‡è£½åˆ†äº«é€£çµ</button>
      <button class="primary" id="btnCopyCard">è¤‡è£½çµæœå¡</button>
    </div>

    <hr style="border:none;border-top:1px solid #e5e5e5;margin:16px 0;" />

    <div style="font-weight:700;margin-bottom:8px;">å„æ§‹é¢åˆ†æ•¸ï¼ˆå«ç¿»ç›¤æç¤ºï¼‰</div>
    <div id="scores" class="scores"></div>
  </div>
</div>

<div id="toast" class="toast">å·²è¤‡è£½</div>

<script>
/** =========================
 *  è³‡æ–™å€ï¼šé¡Œç›®èˆ‡çµæœ
 *  ========================= */

const dims = [
  { keyA: "B", keyB: "T", name: "ç¤¾äº¤èƒ½é‡ï¼ˆB / Tï¼‰", param: "bt" },
  { keyA: "P", keyB: "V", name: "å·¥ä½œé¢¨æ ¼ï¼ˆP / Vï¼‰", param: "pv" },
  { keyA: "C", keyB: "D", name: "æ±ºç­–æ¨¡å¼ï¼ˆC / Dï¼‰", param: "cd" },
  { keyA: "O", keyB: "F", name: "æ‡‰è®Šç¯€å¥ï¼ˆO / Fï¼‰", param: "of" },
];

const questions = [
  { dimIndex: 0, text: "Q1ï½œå¿™åˆ°çˆ†ç‚¸çš„ä¸€å¤©çµæŸå¾Œï¼Œä½ æ¯”è¼ƒæƒ³ï¼š", aText: "è·ŸåŒäº‹ä¸€èµ·æŠ±æ€¨ï¼‹å–æš–ï¼ˆBï¼‰", bText: "ç«‹åˆ»é€²å…¥çœé›»æ¨¡å¼ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q2ï½œä¼‘æ¯æ™‚é–“ä½ é€šå¸¸ï¼š", aText: "æ‰¾äººä¸€èµ·åƒé£¯èŠå¤©ï¼ˆBï¼‰", bText: "ä¸€å€‹äººæ»‘æ‰‹æ©Ÿæ›´èˆ’æœï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q3ï½œé‡åˆ°æ–°ä¾†çš„å¯¦ç¿’ç”Ÿæ™‚ä½ ï¼š", aText: "ç«‹åˆ»è®Šæˆç†±å¿ƒå‰è¼©ï¼ˆBï¼‰", bText: "é»˜é»˜è§€å¯Ÿå†æ±ºå®šè¦ä¸è¦èªªè©±ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q4ï½œé–‹æœƒæ™‚ä½ æ¯”è¼ƒï¼š", aText: "æœƒå¿ä¸ä½æ’è©±è£œå……ï¼ˆBï¼‰", bText: "åªåœ¨å¿…è¦æ™‚ç™¼è¨€ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q5ï½œåŒäº‹ç´„ä¸‹ç­èšé¤ä½ é€šå¸¸ï¼š", aText: "åªè¦ä¸æ˜¯å¤ªç´¯å°±å»ï¼ˆBï¼‰", bText: "å¿ƒè£¡å…ˆæƒ³ã€Œæˆ‘åªæƒ³è¶•å¿«å›å®¶...ã€ï¼ˆTï¼‰", aKey:"B", bKey:"T" },

  { dimIndex: 1, text: "Q6ï½œé¢å°ç—…ä¾‹æ™‚ä½ æ¯”è¼ƒåƒï¼š", aText: "SOP å°±æ˜¯æˆ‘çš„å®‰å…¨æ„Ÿï¼ˆPï¼‰", bText: "å…ˆé ç›´è¦ºå†æ…¢æ…¢é©—è­‰ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q7ï½œå­¸æ–°é€²çš„å„€å™¨æ™‚ä½ ï¼š", aText: "ä¸€å®šè¦æœ‰æ“ä½œæ­¥é©Ÿè¡¨ï¼ˆPï¼‰", bText: "æ‘¸ä¸€æ‘¸å°±å¤§æ¦‚æ‡‚äº†ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q8ï½œæ­£åœ¨æ‰“ç—…æ­·æ™‚ä½ ï¼š", aText: "æ ¼å¼ä¸€å®šè¦æ•´é½Šæ¼‚äº®ï¼ˆPï¼‰", bText: "é‡é»å¯«åˆ°å°±å¥½ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q9ï½œé‡åˆ°è¤‡é›œç‹€æ³ä½ ï¼š", aText: "å…ˆç¿»ç´€éŒ„æˆ–æ˜¯ Paper æ‰¾ä¾æ“šï¼ˆPï¼‰", bText: "å…ˆæƒ³å¯èƒ½æ€§å†èªªï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q10ï½œä½ æ¯”è¼ƒæ“…é•·ï¼š", aText: "æŠŠä¾‹è¡Œå·¥ä½œåšå¾—å¾ˆç©©ï¼ˆPï¼‰", bText: "è™•ç†çªç™¼å¥‡æ€ªæ¡ˆä»¶ï¼ˆVï¼‰", aKey:"P", bKey:"V" },

  { dimIndex: 2, text: "Q11ï½œé‡åˆ°é†«ç™‚ç³¾ç´›æ™‚ä½ å…ˆæƒ³ï¼š", aText: "æ˜¯å¦æ˜¯å°ˆæ¥­çš„å•é¡Œï¼Œå°éŒ¯åœ¨å“ªï¼ˆCï¼‰", bText: "ä¸»äººç¾åœ¨çš„æƒ…ç·’å¾ˆç·Šç¹ƒï¼Œæˆ‘è¦æ€éº¼å®‰æ’«ä¸»äººï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q12ï½œåŒäº‹å‡ºåŒ…æ™‚ä½ æœƒï¼š", aText: "å…ˆè¬›é‡é»æ€éº¼ä¿®æ­£ï¼ˆCï¼‰", bText: "å…ˆèªªã€Œæ²’äº‹æ²’äº‹ã€ï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q13ï½œå®‰æ’«ä¸»äººä½ æ¯”è¼ƒåƒï¼š", aText: "èªªæ˜é¢¨éšªèˆ‡æ•¸æ“šï¼ˆCï¼‰", bText: "ç”¨èªæ°£è·Ÿæ…‹åº¦å®‰æ’«ï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q14ï½œåšæ±ºå®šæ™‚ä½ ï¼š", aText: "ç”¨è…¦è¢‹åˆ†æï¼ˆCï¼‰", bText: "ç”¨å¿ƒæ„Ÿè¦ºï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q15ï½œä½ æ›´åœ¨æ„ï¼š", aText: "æŠŠäº‹æƒ…åšå°ï¼ˆCï¼‰", bText: "ä¸è¦å‚·æ„Ÿæƒ…ï¼ˆDï¼‰", aKey:"C", bKey:"D" },

  { dimIndex: 3, text: "Q16ï½œç­è¡¨è¢«è‡¨æ™‚æ›´å‹•æ™‚ä½ ï¼š", aText: "å…§å¿ƒæœƒå°å´©æ½°ï¼ˆOï¼‰", bText: "è¦ºå¾—ã€Œå¥½å–” OKã€ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q17ï½œæ¯å¤©å·¥ä½œä½ åå¥½ï¼š", aText: "å…ˆæ’å¥½é †åºå†åšï¼ˆOï¼‰", bText: "ä¾†ä¸Šç­ä¹‹å¾Œï¼Œæœ‰ä»€éº¼åšä»€éº¼ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q18ï½œè£œç—…æ­·æ™‚ä½ é€šå¸¸ï¼š", aText: "ç•¶å¤©ä¸€å®šæ¸…å®Œï¼ˆOï¼‰", bText: "ç›¸ä¿¡æ˜å¤©çš„æˆ‘æœƒè™•ç†ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q19ï½œé‡åˆ°è¶…æ™‚æ›è™Ÿçš„ä½ ï¼š", aText: "å¿ƒè£¡ OS å¾ˆå¤šï¼ˆOï¼‰", bText: "ç›´æ¥æ¥å°±å°äº†ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q20ï½œè‡¨æ™‚æœ‰åŒäº‹è«‹å‡éœ€è¦æ”¯æ´æ™‚ä½ ï¼š", aText: "æœƒå¸Œæœ›æå‰çŸ¥é“èˆ‡å®‰æ’ï¼ˆOï¼‰", bText: "ç¾å ´éœ€è¦å°±ç›´æ¥ä¸Šï¼Œæœ‰éŒ¢ä¸è³ºï¼Œç‹å…«è›‹ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
];

const typeMap = {
  "BPCO": { title: "ğŸ¶ã€å¾·åœ‹ç‰§ç¾ŠçŠ¬å‹ç¸é†«ã€‘", trait: ["ç´€å¾‹æ”¯æŸ±å‹","å¤–å‘å¯é ","é‡æµç¨‹ã€è¬›æ•ˆç‡","åœ˜éšŠæ ¸å¿ƒäººç‰©"], quote: "ã€Œäº¤çµ¦æˆ‘ï¼Œæˆ‘è™•ç†ã€‚ã€" },
  "BPCF": { title: "ğŸ•ã€ç±³æ ¼é­¯å‹ç¸é†«ã€‘", trait: ["æ´»åŠ›åŸ·è¡Œè€…","ç†±å¿ƒåˆå‹™å¯¦","åšäº‹æœ‰æ•ˆç‡"], quote: "ã€Œé‚Šåšé‚Šèª¿æ•´ï¼ã€" },
  "BPDO": { title: "ğŸ•ã€é»ƒé‡‘çµçŠ¬å‹ç¸é†«ã€‘", trait: ["æš–å¿ƒè¡Œå‹•æ´¾","ç†±æƒ…åˆè² è²¬","ç—…ä¸»æœ€å®‰å¿ƒ"], quote: "ã€Œæˆ‘æ‡‚ä½ ï¼Œæˆ‘ä¾†å¹«å¿™ã€‚ã€" },
  "BPDF": { title: "ğŸ•ã€æŸ¯åŸºå‹ç¸é†«ã€‘", trait: ["è¦ªåˆ‡å¯¦å‹™å‹","å¯æ„›åˆå¥½ç›¸è™•","åšäº‹æ¥åœ°æ°£"], quote: "ã€Œæ²’äº‹çš„ï½æ…¢æ…¢ä¾†ã€‚ã€" },
  "BVCO": { title: "ğŸ±ã€å­ŸåŠ æ‹‰è²“å‹ç¸é†«ã€‘", trait: ["ç­–ç•¥é ˜å°å‹","ç›´è¦ºå¼·","å–„æ–¼è¦åŠƒ"], quote: "ã€Œè®“æˆ‘æƒ³ä¸€ä¸‹å…¨å±€ã€‚ã€" },
  "BVCF": { title: "ğŸ±ã€è±¹è²“å‹ç¸é†«ã€‘", trait: ["æ©Ÿå‹•æ•‘ç«éšŠ","éˆæ´»åˆç†æ€§"], quote: "ã€Œçªç™¼ï¼Ÿæˆ‘OKã€‚ã€" },
  "BVDO": { title: "ğŸ¶ã€é‚Šå¢ƒç‰§ç¾ŠçŠ¬å‹ã€‘", trait: ["ç†±è¡€é ˜éšŠå‹","æœ‰æƒ³æ³•åˆè²¼å¿ƒ"], quote: "ã€Œæˆ‘å€‘ä¸€èµ·æå®šï¼ã€" },
  "BVDF": { title: "ğŸ¶ã€æŸ´çŠ¬å‹ç¸é†«ã€‘", trait: ["æ°£æ°›ç‹è€…","åœ˜éšŠé–‹å¿ƒæœ"], quote: "ã€Œæˆ‘ä¾†ï¼Œæˆ‘ä¾†ï¼ã€" },
  "TPCO": { title: "ğŸ±ã€è‹±åœ‹çŸ­æ¯›è²“å‹ã€‘", trait: ["å†·éœå°ˆæ¥­æ´¾","ç©©å®šå¯é "], quote: "ã€Œå…ˆæŒ‰ SOP èµ°ã€‚ã€" },
  "TPCF": { title: "ğŸ±ã€ä¿„ç¾…æ–¯è—è²“å‹ã€‘", trait: ["ä½èª¿æ•ˆç‡å‹","å®‰éœä½†å¼·"], quote: "ã€Œé»˜é»˜æŠŠäº‹åšå¥½ã€‚ã€" },
  "TPDO": { title: "ğŸ¶ã€æ³•é¬¥å‹ç¸é†«ã€‘", trait: ["æº«å’Œå¯¦å¹¹æ´¾"], quote: "ã€Œä¸€æ­¥ä¸€æ­¥ä¾†ã€‚ã€" },
  "TPDF": { title: "ğŸ±ã€å¸ƒå¶è²“å‹ç¸é†«ã€‘", trait: ["ä½›ç³»æš–å¿ƒå‹"], quote: "ã€Œå¤§å®¶éƒ½è¾›è‹¦äº†ã€‚ã€" },
  "TVCO": { title: "ğŸ±ã€æŒªå¨æ£®æ—è²“å‹ã€‘", trait: ["åˆ†æç­–ç•¥å‹"], quote: "ã€Œæˆ‘å…ˆç ”ç©¶ä¸€ä¸‹ã€‚ã€" },
  "TVCF": { title: "ğŸ±ã€æš¹ç¾…è²“å‹ã€‘", trait: ["å†·éœå½ˆæ€§å‹"], quote: "ã€Œéš¨æ©Ÿæ‡‰è®Šã€‚ã€" },
  "TVDO": { title: "ğŸ¶ã€æ‹‰å¸ƒæ‹‰å¤šå‹ã€‘", trait: ["å…§æ–‚é ˜å°è€…"], quote: "ã€Œç©©ç©©åœ°åšå°±å¥½ã€‚ã€" },
  "TVDF": { title: "ğŸ¶ã€è–©æ‘©è€¶å‹ã€‘", trait: ["æº«æŸ”æ™ºè€…å‹"], quote: "ã€Œæ²’äº‹ï¼Œæˆ‘é™ªä½ ã€‚ã€" },
};

/** =========================
 *  é˜²äº‚æ”¹ï¼šsigï¼ˆç”¨ WebCrypto SHA-256ï¼‰
 *  ========================= */

// ä½ å¯ä»¥æ”¹é€™å€‹ SALTï¼ˆåƒå¯†ç¢¼ä¸€æ¨£ï¼‰ï¼Œåˆ¥äººå°±æ›´é›£ã€Œç…§æŠ„ç®—ç°½åã€
const SIG_SALT = "vet-16type-v1::change-me";

function canonicalString(code, paramsObj) {
  // å›ºå®šé †åºçµ„å­—ä¸²ï¼Œé¿å…åƒæ•¸é †åºä¸åŒå°è‡´ç°½åä¸åŒ
  return `r=${code}&bt=${paramsObj.bt}&pv=${paramsObj.pv}&cd=${paramsObj.cd}&of=${paramsObj.of}&salt=${SIG_SALT}`;
}

async function sha256Hex(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

async function makeSig(code, pairs) {
  const canon = canonicalString(code, pairs);
  const hex = await sha256Hex(canon);
  // å–çŸ­ä¸€é»å°±å¥½ï¼ˆä»è¶³å¤ é˜²æ‰‹æ”¹ï¼‰ï¼Œ16 å€‹ hex = 64bits
  return hex.slice(0, 16);
}

/** =========================
 *  å·¥å…·
 *  ========================= */

function toast(text) {
  const t = document.getElementById("toast");
  t.textContent = text;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1200);
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast("å·²è¤‡è£½ âœ…");
  } catch (e) {
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast("å·²è¤‡è£½ âœ…");
  }
}

function flipHint(aKey, aScore, bKey, bScore) {
  const diff = Math.abs(aScore - bScore);
  const need = Math.floor(diff / 2) + 1;
  const leader = aScore > bScore ? aKey : bKey;
  return `ç›®å‰ ${leader} é ˜å…ˆï½œå·® ${need} é¡Œç¿»ç›¤`;
}

function encodePair(a, b) { return `${a}-${b}`; }
function decodePair(str) {
  if (!/^\d-\d$/.test(str)) return null;
  const [a, b] = str.split("-").map(x => parseInt(x, 10));
  if ([a,b].some(n => isNaN(n) || n < 0 || n > 5)) return null;
  if (a + b !== 5) return null;
  if (a === b) return null;
  return { a, b };
}

/** =========================
 *  UI Render
 *  ========================= */

function renderQuiz() {
  const root = document.getElementById("quiz");
  root.innerHTML = "";

  dims.forEach((d, dimIndex) => {
    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = `<div class="section-title">ğŸ§© ${d.name}</div><div class="small">ï¼ˆæ­¤æ§‹é¢ï¼š${d.keyA} vs ${d.keyB}ï¼Œå…± 5 é¡Œï¼‰</div>`;
    root.appendChild(sec);

    questions
      .map((q, idx) => ({ q, idx }))
      .filter(x => x.q.dimIndex === dimIndex)
      .forEach(({ q, idx }) => {
        const qId = `q${idx}`;
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `
          <h3>${q.text}</h3>
          <div class="opt">
            <label><input type="radio" name="${qId}" value="A" /> A. ${q.aText}</label>
            <label><input type="radio" name="${qId}" value="B" /> B. ${q.bText}</label>
          </div>
          <div class="small">é¸ A â†’ ${q.aKey} +1 ï½œ é¸ B â†’ ${q.bKey} +1</div>
        `;
        root.appendChild(div);
      });
  });
}

function getAnswers() {
  return questions.map((_, i) =>
    document.querySelector(`input[name="q${i}"]:checked`)?.value || null
  );
}

/** =========================
 *  è¨ˆç®— / é¡¯ç¤º / åˆ†äº«
 *  ========================= */

function computeFromAnswers(answers) {
  const score = { B:0, T:0, P:0, V:0, C:0, D:0, O:0, F:0 };

  answers.forEach((ans, i) => {
    const q = questions[i];
    const key = (ans === "A") ? q.aKey : q.bKey;
    score[key] += 1;
  });

  const letters = dims.map(d => (score[d.keyA] > score[d.keyB]) ? d.keyA : d.keyB);
  const code = letters.join("");

  const pairs = {};
  dims.forEach(d => {
    pairs[d.param] = encodePair(score[d.keyA], score[d.keyB]);
  });

  return { score, code, pairs };
}

async function setShareParamsWithSig({code, pairs}) {
  const sig = await makeSig(code, pairs);
  const url = new URL(window.location.href);
  url.searchParams.set("r", code);
  dims.forEach(d => url.searchParams.set(d.param, pairs[d.param]));
  url.searchParams.set("sig", sig);
  window.history.replaceState({}, "", url.toString());
}

function renderResult({score, code}) {
  const info = typeMap[code] || { title: "æœªå®šç¾©çµæœ", trait: ["è«‹è£œä¸Š typeMap å°ç…§"], quote: "" };

  document.getElementById("code").textContent = code;
  document.getElementById("typeTitle").textContent = info.title;

  const traitHTML = Array.isArray(info.trait)
    ? `<ul>${info.trait.map(t => `<li>${t}</li>`).join("")}</ul>`
    : `<div>${info.trait}</div>`;
  document.getElementById("typeTrait").innerHTML = traitHTML;

  document.getElementById("typeQuote").textContent = info.quote || "";

  const scoresBox = document.getElementById("scores");
  scoresBox.innerHTML = "";

  dims.forEach(d => {
    const a = score[d.keyA];
    const b = score[d.keyB];
    const winner = a > b ? d.keyA : d.keyB;

    const card = document.createElement("div");
    card.className = "score-line";
    card.innerHTML = `
      <div style="font-weight:700;">${d.name}</div>
      <div class="two">
        <div>${d.keyA}ï¼š<span class="mono">${a}</span></div>
        <div>${d.keyB}ï¼š<span class="mono">${b}</span></div>
      </div>
      <div class="small">
        çµæœï¼š<b>${winner}</b> ï½œ <span class="mono">${d.keyA} ${a} / ${d.keyB} ${b}</span> ï½œ ${flipHint(d.keyA, a, d.keyB, b)}
      </div>
      <div class="bar" title="${d.keyA} vs ${d.keyB}">
        <div style="width:${(a/5)*100}%"></div>
      </div>
      <div class="small">é•·æ¢ç‚º ${d.keyA} ä½”æ¯”ï¼ˆ0~5ï¼‰</div>
    `;
    scoresBox.appendChild(card);
  });

  document.getElementById("result").style.display = "block";
}

function buildResultCardText({score, code}) {
  const info = typeMap[code] || { title: "æœªå®šç¾©çµæœ", trait: [], quote: "" };
  const url = window.location.href;

  const dimLines = dims.map(d => {
    const a = score[d.keyA], b = score[d.keyB];
    const winner = a > b ? d.keyA : d.keyB;
    return `- ${d.name}ï¼š${d.keyA} ${a} / ${d.keyB} ${b} â†’ ${winner}ï¼ˆ${flipHint(d.keyA, a, d.keyB, b)}ï¼‰`;
  }).join("\n");

  const traits = Array.isArray(info.trait) && info.trait.length
    ? info.trait.map(t => `- ${t}`).join("\n")
    : "";

  return [
    `ã€ç¸é†« 16 å‹äººæ ¼æ¸¬é©—çµæœã€‘`,
    `å››å­—æ¯ï¼š${code}`,
    `${info.title}`,
    traits ? `\nç‰¹è³ªï¼š\n${traits}` : "",
    info.quote ? `\nä»£è¡¨å¥ï¼š${info.quote}` : "",
    `\næ§‹é¢åˆ†æ•¸ï¼š\n${dimLines}`,
    `\nåˆ†äº«é€£çµï¼š${url}`
  ].filter(Boolean).join("\n");
}

async function calcFromUI() {
  const msg = document.getElementById("msg");
  msg.style.display = "none";
  msg.textContent = "";

  const answers = getAnswers();
  const missing = answers.map((v, i) => v ? null : i + 1).filter(Boolean);
  if (missing.length) {
    msg.style.display = "block";
    msg.textContent = `ä½ é‚„æœ‰ ${missing.length} é¡Œæœªä½œç­”ï¼šç¬¬ ${missing.join(", ")} é¡Œ`;
    return;
  }

  const computed = computeFromAnswers(answers);
  await setShareParamsWithSig({ code: computed.code, pairs: computed.pairs });
  renderResult({ score: computed.score, code: computed.code });

  document.getElementById("result").scrollIntoView({ behavior: "smooth" });
}

function resetAll() {
  document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
  document.getElementById("result").style.display = "none";
  const msg = document.getElementById("msg");
  msg.style.display = "none";
  msg.textContent = "";

  const url = new URL(window.location.href);
  ["r","sig", ...dims.map(d => d.param)].forEach(k => url.searchParams.delete(k));
  window.history.replaceState({}, "", url.toString());

  document.getElementById("mainActions").style.display = "";
  document.getElementById("topHint").innerHTML =
    `ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼›è©²é¸é …å°æ‡‰çš„å­—æ¯ +1ã€‚<br/>
     çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚`;

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/** =========================
 *  è®€å–åˆ†äº«é€£çµï¼ˆå« sigï¼‰
 *  ========================= */

async function showResultFromParamsIfAny() {
  const url = new URL(window.location.href);
  const r = (url.searchParams.get("r") || "").toUpperCase().trim();
  if (!r) return;

  const codeOk = /^[BT][PV][CD][OF]$/.test(r) && typeMap[r];
  if (!codeOk) return;

  const sig = (url.searchParams.get("sig") || "").trim();
  if (!sig) {
    const msg = document.getElementById("msg");
    msg.style.display = "block";
    msg.textContent = "æ­¤åˆ†äº«é€£çµç¼ºå°‘é©—è­‰ç¢¼ï¼ˆsigï¼‰ï¼Œå¯èƒ½å·²è¢«ä¿®æ”¹æˆ–ç‰ˆæœ¬éèˆŠã€‚";
    return;
  }

  // è§£æå››çµ„åˆ†æ•¸
  const pairs = {};
  const score = { B:0, T:0, P:0, V:0, C:0, D:0, O:0, F:0 };

  for (const d of dims) {
    const raw = (url.searchParams.get(d.param) || "").trim();
    const pair = decodePair(raw);
    if (!pair) {
      const msg = document.getElementById("msg");
      msg.style.display = "block";
      msg.textContent = "æ­¤åˆ†äº«é€£çµçš„åˆ†æ•¸åƒæ•¸ä¸å®Œæ•´æˆ–ä¸åˆæ³•ï¼ˆéœ€ç‚º 5 é¡Œåˆ¶ï¼Œä¾‹å¦‚ 4-1ï¼‰ã€‚";
      return;
    }
    pairs[d.param] = raw;
    score[d.keyA] = pair.a;
    score[d.keyB] = pair.b;

    // åˆ†æ•¸å¿…é ˆèˆ‡ r çš„å‹è² ä¸€è‡´
    const winner = (pair.a > pair.b) ? d.keyA : d.keyB;
    const expected = r[dims.indexOf(d)];
    if (winner !== expected) {
      const msg = document.getElementById("msg");
      msg.style.display = "block";
      msg.textContent = "åˆ†äº«é€£çµçš„ r èˆ‡åˆ†æ•¸å‹è² ä¸ä¸€è‡´ï¼Œå¯èƒ½è¢«æ‰‹å‹•ä¿®æ”¹ã€‚";
      return;
    }
  }

  // é©—è­‰ sig
  const expectedSig = await makeSig(r, pairs);
  if (expectedSig !== sig) {
    const msg = document.getElementById("msg");
    msg.style.display = "block";
    msg.textContent = "æ­¤åˆ†äº«é€£çµå·²è¢«ä¿®æ”¹ï¼ˆsig é©—è­‰å¤±æ•—ï¼‰ã€‚è«‹é‡æ–°ç”¢ç”Ÿåˆ†äº«é€£çµã€‚";
    return;
  }

  // é€²å…¥åˆ†äº«å±•ç¤ºæ¨¡å¼
  document.getElementById("topHint").innerHTML =
    `ä½ æ­£åœ¨æŸ¥çœ‹åˆ†äº«çµæœï¼š<span class="mono">${r}</span>ï¼ˆæ­¤é€£çµåŒ…å«çœŸå¯¦åˆ†æ•¸ï¼Œä¸”å·²é€šéé©—è­‰ï¼‰`;
  document.getElementById("mainActions").style.display = "none";

  renderResult({ score, code: r });
  document.getElementById("result").scrollIntoView({ behavior: "smooth" });
}

/** =========================
 *  åˆå§‹åŒ–
 *  ========================= */

renderQuiz();
showResultFromParamsIfAny();

document.getElementById("btnCalc").addEventListener("click", calcFromUI);
document.getElementById("btnReset").addEventListener("click", resetAll);

document.getElementById("btnCopyLink").addEventListener("click", async () => {
  const url = new URL(window.location.href);
  const hasR = url.searchParams.get("r");
  const hasSig = url.searchParams.get("sig");
  if (!hasR || !hasSig) {
    const msg = document.getElementById("msg");
    msg.style.display = "block";
    msg.textContent = "è«‹å…ˆå®Œæˆ 20 é¡Œä¸¦æŒ‰ã€Œè¨ˆç®—çµæœã€ï¼Œæ‰æœƒç”¢ç”Ÿå¯åˆ†äº«çš„é€£çµï¼ˆå« sigï¼‰ã€‚";
    return;
  }
  copyText(window.location.href);
});

document.getElementById("btnCopyCard").addEventListener("click", async () => {
  const url = new URL(window.location.href);
  const r = (url.searchParams.get("r") || "").toUpperCase().trim();
  const sig = (url.searchParams.get("sig") || "").trim();

  // è‹¥ URL æœ‰å®Œæ•´åƒæ•¸ï¼Œå…ˆé©— sig å†è¤‡è£½ï¼ˆé¿å…è¤‡è£½åˆ°è¢«æ”¹éçš„é€£çµï¼‰
  if (r && typeMap[r] && sig) {
    const pairs = {};
    const score = { B:0, T:0, P:0, V:0, C:0, D:0, O:0, F:0 };

    for (const d of dims) {
      const raw = (url.searchParams.get(d.param) || "").trim();
      const pair = decodePair(raw);
      if (!pair) {
        const msg = document.getElementById("msg");
        msg.style.display = "block";
        msg.textContent = "ç›®å‰ç¶²å€ç¼ºå°‘å®Œæ•´åˆ†æ•¸åƒæ•¸ï¼Œè«‹é‡æ–°è¨ˆç®—çµæœå¾Œå†è¤‡è£½çµæœå¡ã€‚";
        return;
      }
      pairs[d.param] = raw;
      score[d.keyA] = pair.a;
      score[d.keyB] = pair.b;
    }

    const expectedSig = await makeSig(r, pairs);
    if (expectedSig !== sig) {
      const msg = document.getElementById("msg");
      msg.style.display = "block";
      msg.textContent = "ç›®å‰ç¶²å€çš„ sig é©—è­‰å¤±æ•—ï¼ˆå¯èƒ½è¢«æ”¹éï¼‰ã€‚è«‹é‡æ–°è¨ˆç®—çµæœç”¢ç”Ÿæ–°é€£çµã€‚";
      return;
    }

    copyText(buildResultCardText({ score, code: r }));
    return;
  }

  // å¦å‰‡ï¼šä½¿ç”¨ä½œç­”é‡ç®—ï¼ˆä¹Ÿæœƒå¯«å…¥ URL + sigï¼‰
  const answers = getAnswers();
  if (answers.some(v => !v)) {
    const msg = document.getElementById("msg");
    msg.style.display = "block";
    msg.textContent = "è¦è¤‡è£½çµæœå¡å‰ï¼Œè«‹å…ˆå®Œæˆ 20 é¡Œä¸¦è¨ˆç®—çµæœã€‚";
    return;
  }

  const computed = computeFromAnswers(answers);
  await setShareParamsWithSig({ code: computed.code, pairs: computed.pairs });
  renderResult({ score: computed.score, code: computed.code });
  copyText(buildResultCardText({ score: computed.score, code: computed.code }));
});
</script>
</body>
</html>

