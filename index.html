<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¸é†« 16 å‹äººæ ¼æ¸¬é©—</title>
  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#e8e8e8;
      --shadow:0 12px 26px rgba(0,0,0,.08);
      --shadow2:0 18px 34px rgba(0,0,0,.12);
      --radius:18px;
      --radius2:22px;
      --black:#111;
      --soft:#fafafa;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",Arial,sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 110px;}
    h1{margin:6px 0 6px;font-size:28px;letter-spacing:.2px}
    .tag{
      display:inline-block;padding:4px 10px;border:1px solid var(--line);
      border-radius:999px;font-size:12px;color:#444;background:#fff;margin-left:10px;
      vertical-align:middle;
    }
    .hint{color:#444;margin:10px 0 14px}
    .topbar{
      position:sticky;top:0;z-index:20;
      background:rgba(246,246,246,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .topbar-inner{max-width:980px;margin:0 auto;padding:12px 18px;}
    .progress-row{display:flex;align-items:center;gap:12px}
    .progress{
      flex:1;height:12px;background:#eaeaea;border-radius:999px;overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
    }
    .progress>div{height:100%;width:0%;background:#111;transition:width .2s ease}
    .progress-text{min-width:120px;text-align:right;color:#444;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    .section{
      margin:18px 0 8px;padding:12px 14px;border-radius:var(--radius2);
      background:linear-gradient(180deg,#fff,#fbfbfb);
      border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .section-title{font-weight:800}
    .small{font-size:13px;color:var(--muted)}
    .q{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:14px;
      background:var(--card);
      box-shadow:var(--shadow);
    }
    .q h3{margin:0 0 10px;font-size:16px}
    /* Option cards with illustrations */
    .opt-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 8px;}
    @media(max-width:740px){.opt-cards{grid-template-columns:1fr;}}
    .opt-card{
      border:1px solid #e7e7e7;
      border-radius:18px;
      background:#fff;
      padding:14px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      display:flex;flex-direction:column;gap:12px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .opt-card:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(0,0,0,.08);}
    .opt-card.selected{border-color:#111;box-shadow:var(--shadow2);}
    .opt-ill{
      border-radius:16px;
      border:1px solid #eee;
      background: linear-gradient(180deg,#fff,#fafafa);
      padding:10px;
      display:flex;align-items:center;justify-content:center;
      min-height:92px;
    }
    .opt-ill svg{width:96px;height:96px;}
    .opt-meta{display:flex;gap:10px;align-items:flex-start;}
    .opt-badge{
      width:34px;height:34px;border-radius:12px;background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:900;flex:0 0 auto;
    }
    .opt-text{font-size:15px;color:#222;line-height:1.55;}
    .opt-pick{
      display:flex;gap:10px;align-items:center;justify-content:center;
      padding:10px 12px;border:1px solid #e7e7e7;border-radius:14px;background:#fafafa;
      user-select:none;
    }
    .opt-card.selected .opt-pick{border-color:#111;background:#111;color:#fff;}
    .opt-pick input{transform:scale(1.15);accent-color:#111;}
    .opt-card.selected .opt-pick input{accent-color:#fff;}

    /* Bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.08);
    }
    .bottom-inner{
      max-width:980px;margin:0 auto;padding:12px 18px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .btn{
      padding:10px 14px;border-radius:14px;border:1px solid #cfcfcf;background:#fff;
      cursor:pointer;font-weight:700;
    }
    .btn.primary{border-color:#111;background:#111;color:#fff;}
    .btn.ghost{background:#fafafa;}
    .nav-left,.nav-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .nav-mid{color:#444;font-size:13px}
    .warn{color:#b00020;margin-top:10px;display:none;font-weight:700}

    /* Result */
    .result{
      margin-top:22px;padding:16px;border:1px solid var(--line);border-radius:var(--radius2);
      background:linear-gradient(180deg,#fff,#fbfbfb);
      box-shadow:var(--shadow2);
      display:none;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .type-title{font-size:20px;font-weight:900;margin:8px 0 10px;}
    .scores{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;}
    .score-line{
      padding:12px;border-radius:16px;border:1px solid #ededed;background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
    }
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:740px){.two{grid-template-columns:1fr;}}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin-top:8px;}
    .bar>div{height:100%;width:50%;background:#bbb;}
    .result-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    hr{border:none;border-top:1px solid #e5e5e5;margin:16px 0;}
    .toast{
      position:fixed;left:50%;bottom:88px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 12px;border-radius:999px;
      font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s;
      z-index:60;
    }
    .toast.show{opacity:1;}

    /* Stats */
    .stats{
      margin-top:16px;padding:14px;border-radius:18px;border:1px solid var(--line);
      background:#fff;box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .stats h4{margin:0 0 10px;font-size:16px}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:740px){.stats-grid{grid-template-columns:1fr;}}
    .stat-card{border:1px solid #eee;border-radius:16px;padding:12px;background:#fafafa;}
    .stat-big{font-size:20px;font-weight:900}
    .rank{margin-top:10px;border-top:1px solid #eee;padding-top:10px;}
    .rank-item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;}
    .dim-chip{display:inline-block;border:1px solid #eee;border-radius:999px;padding:2px 10px;font-size:12px;background:#fff;color:#444}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="progress-row">
        <div class="progress" aria-label="é€²åº¦">
          <div id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 20</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>ç¸é†« 16 å‹äººæ ¼æ¸¬é©— <span class="tag">20 é¡Œï½œ4 æ§‹é¢ï½œäºŒé¸ä¸€</span></h1>
    <div class="hint" id="topHint">
      ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼›è©²é¸é …å°æ‡‰çš„å­—æ¯ +1ã€‚<br />
      çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚<br />
      åˆ†äº«æ–¹å¼ï¼šç¶²å€æœƒå¸¶ä¸Š <span class="mono">r / bt / pv / cd / of / sig</span>ï¼ˆå«çœŸå¯¦åˆ†æ•¸ + é˜²æ‰‹æ”¹é©—è­‰ï¼‰ã€‚
    </div>

    <div id="quiz" class="grid"></div>
    <div id="msg" class="warn"></div>

    <div id="result" class="result">
      <div>ä½ çš„å››å­—æ¯ï¼š<span class="mono" id="code"></span></div>
      <div class="type-title" id="typeTitle"></div>
      <div id="typeTrait"></div>
      <div style="margin-top:10px;"><b>ä»£è¡¨å¥ï¼š</b><span id="typeQuote"></span></div>

      <div class="result-actions">
        <button class="btn" id="btnCopyLink">è¤‡è£½åˆ†äº«é€£çµ</button>
        <button class="btn primary" id="btnCopyCard">è¤‡è£½çµæœå¡</button>
        <button class="btn ghost" id="btnBackToQuiz">å›åˆ°ä½œç­”</button>
      </div>

      <hr />

      <div style="font-weight:900;margin-bottom:8px;">å„æ§‹é¢åˆ†æ•¸ï¼ˆå«ç¿»ç›¤æç¤ºï¼‰</div>
      <div id="scores" class="scores"></div>

      <div class="stats" id="statsBox" style="display:none;">
        <h4>ğŸ“Š å…¨é«”çµæœçµ±è¨ˆ <span class="dim-chip">å¯é¸åŠŸèƒ½</span></h4>
        <div class="small" id="statsHint"></div>
        <div class="stats-grid" style="margin-top:10px;">
          <div class="stat-card">
            <div class="small">ç›®å‰å·²çµ±è¨ˆäººæ¬¡</div>
            <div class="stat-big" id="statsTotal">-</div>
          </div>
          <div class="stat-card">
            <div class="small">ä½ çš„å‹ï¼ˆæ­¤å‹äººæ•¸ï¼‰</div>
            <div class="stat-big" id="statsMine">-</div>
          </div>
        </div>
        <div class="rank" id="statsRank"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="bottom-inner">
      <div class="nav-left">
        <button class="btn ghost" id="btnPrev">ä¸Šä¸€é¡Œ</button>
        <button class="btn ghost" id="btnNext">ä¸‹ä¸€é¡Œ</button>
      </div>
      <div class="nav-mid" id="navMid">æç¤ºï¼šé»é¸å¡ç‰‡å³å¯ä½œç­”</div>
      <div class="nav-right">
        <button class="btn" id="btnReset">é‡å¡«</button>
        <button class="btn primary" id="btnCalc">è¨ˆç®—çµæœ</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">å·²è¤‡è£½</div>

<script>
/** =========================================================
 *  âœ… ä½ åªéœ€è¦æ”¹å…©å€‹åœ°æ–¹ï¼š
 *  1) SIG_SALTï¼šéš¨ä¾¿æ›ä¸€ä¸²ï¼ˆåƒå¯†ç¢¼ï¼‰ï¼Œé˜²åŒäº‹æ¨¡ä»¿ç°½å
 *  2) STATS_ENDPOINTï¼šè‹¥è¦å…¨é«”çµ±è¨ˆï¼Œå¡« Apps Script Web App URL
 *     - ä¸åšçµ±è¨ˆï¼šä¿æŒç©ºå­—ä¸²å³å¯
 * ========================================================= */

const SIG_SALT = "vet-16type-v1::change-me"; // å»ºè­°ä½ æ›æˆè‡ªå·±çš„éš¨æ©Ÿå­—ä¸²
const STATS_ENDPOINT = ""; // ä¾‹å¦‚ "https://script.google.com/macros/s/xxxxx/exec"ï¼ˆç©ºå­—ä¸²ï¼ä¸å•Ÿç”¨çµ±è¨ˆï¼‰

/** =========================
 *  è³‡æ–™ï¼šæ§‹é¢ / é¡Œç›® / é¡å‹
 *  ========================= */

const dims = [
  { keyA: "B", keyB: "T", name: "ç¤¾äº¤èƒ½é‡ï¼ˆB / Tï¼‰", param: "bt" },
  { keyA: "P", keyB: "V", name: "å·¥ä½œé¢¨æ ¼ï¼ˆP / Vï¼‰", param: "pv" },
  { keyA: "C", keyB: "D", name: "æ±ºç­–æ¨¡å¼ï¼ˆC / Dï¼‰", param: "cd" },
  { keyA: "O", keyB: "F", name: "æ‡‰è®Šç¯€å¥ï¼ˆO / Fï¼‰", param: "of" },
];

const questions = [
  { dimIndex: 0, text: "Q1ï½œå¿™åˆ°çˆ†ç‚¸çš„ä¸€å¤©çµæŸå¾Œï¼Œä½ æ¯”è¼ƒæƒ³ï¼š", aText: "è·ŸåŒäº‹ä¸€èµ·æŠ±æ€¨ï¼‹å–æš–ï¼ˆBï¼‰", bText: "ç«‹åˆ»é€²å…¥çœé›»æ¨¡å¼ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q2ï½œä¼‘æ¯æ™‚é–“ä½ é€šå¸¸ï¼š", aText: "æ‰¾äººä¸€èµ·åƒé£¯èŠå¤©ï¼ˆBï¼‰", bText: "ä¸€å€‹äººæ»‘æ‰‹æ©Ÿæ›´èˆ’æœï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q3ï½œé‡åˆ°æ–°ä¾†çš„å¯¦ç¿’ç”Ÿæ™‚ä½ ï¼š", aText: "ç«‹åˆ»è®Šæˆç†±å¿ƒå‰è¼©ï¼ˆBï¼‰", bText: "é»˜é»˜è§€å¯Ÿå†æ±ºå®šè¦ä¸è¦èªªè©±ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q4ï½œé–‹æœƒæ™‚ä½ æ¯”è¼ƒï¼š", aText: "æœƒå¿ä¸ä½æ’è©±è£œå……ï¼ˆBï¼‰", bText: "åªåœ¨å¿…è¦æ™‚ç™¼è¨€ï¼ˆTï¼‰", aKey:"B", bKey:"T" },
  { dimIndex: 0, text: "Q5ï½œåŒäº‹ç´„ä¸‹ç­èšé¤ä½ é€šå¸¸ï¼š", aText: "åªè¦ä¸æ˜¯å¤ªç´¯å°±å»ï¼ˆBï¼‰", bText: "å¿ƒè£¡å…ˆæƒ³ã€Œæˆ‘åªæƒ³è¶•å¿«å›å®¶...ã€ï¼ˆTï¼‰", aKey:"B", bKey:"T" },

  { dimIndex: 1, text: "Q6ï½œé¢å°ç—…ä¾‹æ™‚ä½ æ¯”è¼ƒåƒï¼š", aText: "SOP å°±æ˜¯æˆ‘çš„å®‰å…¨æ„Ÿï¼ˆPï¼‰", bText: "å…ˆé ç›´è¦ºå†æ…¢æ…¢é©—è­‰ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q7ï½œå­¸æ–°é€²çš„å„€å™¨æ™‚ä½ ï¼š", aText: "ä¸€å®šè¦æœ‰æ“ä½œæ­¥é©Ÿè¡¨ï¼ˆPï¼‰", bText: "æ‘¸ä¸€æ‘¸å°±å¤§æ¦‚æ‡‚äº†ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q8ï½œæ­£åœ¨æ‰“ç—…æ­·æ™‚ä½ ï¼š", aText: "æ ¼å¼ä¸€å®šè¦æ•´é½Šæ¼‚äº®ï¼ˆPï¼‰", bText: "é‡é»å¯«åˆ°å°±å¥½ï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q9ï½œé‡åˆ°è¤‡é›œç‹€æ³ä½ ï¼š", aText: "å…ˆç¿»ç´€éŒ„æˆ–æ˜¯ Paper æ‰¾ä¾æ“šï¼ˆPï¼‰", bText: "å…ˆæƒ³å¯èƒ½æ€§å†èªªï¼ˆVï¼‰", aKey:"P", bKey:"V" },
  { dimIndex: 1, text: "Q10ï½œä½ æ¯”è¼ƒæ“…é•·ï¼š", aText: "æŠŠä¾‹è¡Œå·¥ä½œåšå¾—å¾ˆç©©ï¼ˆPï¼‰", bText: "è™•ç†çªç™¼å¥‡æ€ªæ¡ˆä»¶ï¼ˆVï¼‰", aKey:"P", bKey:"V" },

  { dimIndex: 2, text: "Q11ï½œé‡åˆ°é†«ç™‚ç³¾ç´›æ™‚ä½ å…ˆæƒ³ï¼š", aText: "æ˜¯å¦æ˜¯å°ˆæ¥­çš„å•é¡Œï¼Œå°éŒ¯åœ¨å“ªï¼ˆCï¼‰", bText: "ä¸»äººç¾åœ¨çš„æƒ…ç·’å¾ˆç·Šç¹ƒï¼Œæˆ‘è¦æ€éº¼å®‰æ’«ä¸»äººï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q12ï½œåŒäº‹å‡ºåŒ…æ™‚ä½ æœƒï¼š", aText: "å…ˆè¬›é‡é»æ€éº¼ä¿®æ­£ï¼ˆCï¼‰", bText: "å…ˆèªªã€Œæ²’äº‹æ²’äº‹ã€ï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q13ï½œå®‰æ’«ä¸»äººä½ æ¯”è¼ƒåƒï¼š", aText: "èªªæ˜é¢¨éšªèˆ‡æ•¸æ“šï¼ˆCï¼‰", bText: "ç”¨èªæ°£è·Ÿæ…‹åº¦å®‰æ’«ï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q14ï½œåšæ±ºå®šæ™‚ä½ ï¼š", aText: "ç”¨è…¦è¢‹åˆ†æï¼ˆCï¼‰", bText: "ç”¨å¿ƒæ„Ÿè¦ºï¼ˆDï¼‰", aKey:"C", bKey:"D" },
  { dimIndex: 2, text: "Q15ï½œä½ æ›´åœ¨æ„ï¼š", aText: "æŠŠäº‹æƒ…åšå°ï¼ˆCï¼‰", bText: "ä¸è¦å‚·æ„Ÿæƒ…ï¼ˆDï¼‰", aKey:"C", bKey:"D" },

  { dimIndex: 3, text: "Q16ï½œç­è¡¨è¢«è‡¨æ™‚æ›´å‹•æ™‚ä½ ï¼š", aText: "å…§å¿ƒæœƒå°å´©æ½°ï¼ˆOï¼‰", bText: "è¦ºå¾—ã€Œå¥½å–” OKã€ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q17ï½œæ¯å¤©å·¥ä½œä½ åå¥½ï¼š", aText: "å…ˆæ’å¥½é †åºå†åšï¼ˆOï¼‰", bText: "ä¾†ä¸Šç­ä¹‹å¾Œï¼Œæœ‰ä»€éº¼åšä»€éº¼ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q18ï½œè£œç—…æ­·æ™‚ä½ é€šå¸¸ï¼š", aText: "ç•¶å¤©ä¸€å®šæ¸…å®Œï¼ˆOï¼‰", bText: "ç›¸ä¿¡æ˜å¤©çš„æˆ‘æœƒè™•ç†ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q19ï½œé‡åˆ°è¶…æ™‚æ›è™Ÿçš„ä½ ï¼š", aText: "å¿ƒè£¡ OS å¾ˆå¤šï¼ˆOï¼‰", bText: "ç›´æ¥æ¥å°±å°äº†ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
  { dimIndex: 3, text: "Q20ï½œè‡¨æ™‚æœ‰åŒäº‹è«‹å‡éœ€è¦æ”¯æ´æ™‚ä½ ï¼š", aText: "æœƒå¸Œæœ›æå‰çŸ¥é“èˆ‡å®‰æ’ï¼ˆOï¼‰", bText: "ç¾å ´éœ€è¦å°±ç›´æ¥ä¸Šï¼Œæœ‰éŒ¢ä¸è³ºï¼Œç‹å…«è›‹ï¼ˆFï¼‰", aKey:"O", bKey:"F" },
];

const typeMap = {
  "BPCO": { title: "ğŸ¶ã€å¾·åœ‹ç‰§ç¾ŠçŠ¬å‹ç¸é†«ã€‘", trait: ["ç´€å¾‹æ”¯æŸ±å‹","å¤–å‘å¯é ","é‡æµç¨‹ã€è¬›æ•ˆç‡","åœ˜éšŠæ ¸å¿ƒäººç‰©"], quote: "ã€Œäº¤çµ¦æˆ‘ï¼Œæˆ‘è™•ç†ã€‚ã€" },
  "BPCF": { title: "ğŸ•ã€ç±³æ ¼é­¯å‹ç¸é†«ã€‘", trait: ["æ´»åŠ›åŸ·è¡Œè€…","ç†±å¿ƒåˆå‹™å¯¦","åšäº‹æœ‰æ•ˆç‡"], quote: "ã€Œé‚Šåšé‚Šèª¿æ•´ï¼ã€" },
  "BPDO": { title: "ğŸ•ã€é»ƒé‡‘çµçŠ¬å‹ç¸é†«ã€‘", trait: ["æš–å¿ƒè¡Œå‹•æ´¾","ç†±æƒ…åˆè² è²¬","ç—…ä¸»æœ€å®‰å¿ƒ"], quote: "ã€Œæˆ‘æ‡‚ä½ ï¼Œæˆ‘ä¾†å¹«å¿™ã€‚ã€" },
  "BPDF": { title: "ğŸ•ã€æŸ¯åŸºå‹ç¸é†«ã€‘", trait: ["è¦ªåˆ‡å¯¦å‹™å‹","å¯æ„›åˆå¥½ç›¸è™•","åšäº‹æ¥åœ°æ°£"], quote: "ã€Œæ²’äº‹çš„ï½æ…¢æ…¢ä¾†ã€‚ã€" },
  "BVCO": { title: "ğŸ±ã€å­ŸåŠ æ‹‰è²“å‹ç¸é†«ã€‘", trait: ["ç­–ç•¥é ˜å°å‹","ç›´è¦ºå¼·","å–„æ–¼è¦åŠƒ"], quote: "ã€Œè®“æˆ‘æƒ³ä¸€ä¸‹å…¨å±€ã€‚ã€" },
  "BVCF": { title: "ğŸ±ã€è±¹è²“å‹ç¸é†«ã€‘", trait: ["æ©Ÿå‹•æ•‘ç«éšŠ","éˆæ´»åˆç†æ€§"], quote: "ã€Œçªç™¼ï¼Ÿæˆ‘OKã€‚ã€" },
  "BVDO": { title: "ğŸ¶ã€é‚Šå¢ƒç‰§ç¾ŠçŠ¬å‹ã€‘", trait: ["ç†±è¡€é ˜éšŠå‹","æœ‰æƒ³æ³•åˆè²¼å¿ƒ"], quote: "ã€Œæˆ‘å€‘ä¸€èµ·æå®šï¼ã€" },
  "BVDF": { title: "ğŸ¶ã€æŸ´çŠ¬å‹ç¸é†«ã€‘", trait: ["æ°£æ°›ç‹è€…","åœ˜éšŠé–‹å¿ƒæœ"], quote: "ã€Œæˆ‘ä¾†ï¼Œæˆ‘ä¾†ï¼ã€" },
  "TPCO": { title: "ğŸ±ã€è‹±åœ‹çŸ­æ¯›è²“å‹ã€‘", trait: ["å†·éœå°ˆæ¥­æ´¾","ç©©å®šå¯é "], quote: "ã€Œå…ˆæŒ‰ SOP èµ°ã€‚ã€" },
  "TPCF": { title: "ğŸ±ã€ä¿„ç¾…æ–¯è—è²“å‹ã€‘", trait: ["ä½èª¿æ•ˆç‡å‹","å®‰éœä½†å¼·"], quote: "ã€Œé»˜é»˜æŠŠäº‹åšå¥½ã€‚ã€" },
  "TPDO": { title: "ğŸ¶ã€æ³•é¬¥å‹ç¸é†«ã€‘", trait: ["æº«å’Œå¯¦å¹¹æ´¾"], quote: "ã€Œä¸€æ­¥ä¸€æ­¥ä¾†ã€‚ã€" },
  "TPDF": { title: "ğŸ±ã€å¸ƒå¶è²“å‹ç¸é†«ã€‘", trait: ["ä½›ç³»æš–å¿ƒå‹"], quote: "ã€Œå¤§å®¶éƒ½è¾›è‹¦äº†ã€‚ã€" },
  "TVCO": { title: "ğŸ±ã€æŒªå¨æ£®æ—è²“å‹ã€‘", trait: ["åˆ†æç­–ç•¥å‹"], quote: "ã€Œæˆ‘å…ˆç ”ç©¶ä¸€ä¸‹ã€‚ã€" },
  "TVCF": { title: "ğŸ±ã€æš¹ç¾…è²“å‹ã€‘", trait: ["å†·éœå½ˆæ€§å‹"], quote: "ã€Œéš¨æ©Ÿæ‡‰è®Šã€‚ã€" },
  "TVDO": { title: "ğŸ¶ã€æ‹‰å¸ƒæ‹‰å¤šå‹ã€‘", trait: ["å…§æ–‚é ˜å°è€…"], quote: "ã€Œç©©ç©©åœ°åšå°±å¥½ã€‚ã€" },
  "TVDF": { title: "ğŸ¶ã€è–©æ‘©è€¶å‹ã€‘", trait: ["æº«æŸ”æ™ºè€…å‹"], quote: "ã€Œæ²’äº‹ï¼Œæˆ‘é™ªä½ ã€‚ã€" },
};

/** =========================
 *  8 å€‹å­—æ¯æ’åœ–ï¼ˆå…§åµŒ SVGï¼‰
 *  ========================= */

const ICON_SVG = {
  B: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gB" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#111"/>
        <stop offset="1" stop-color="#555"/>
      </linearGradient>
    </defs>
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M30 70 C40 40, 60 40, 68 62 C78 52, 94 54, 88 72 C82 90, 52 94, 38 80 Z"
          fill="url(#gB)" opacity="0.9"/>
    <circle cx="55" cy="62" r="4" fill="#fff"/>
  </svg>`,
  T: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M40 66 C40 48, 56 40, 72 46 C86 52, 92 68, 80 80 C66 94, 40 86, 40 66 Z"
          fill="#111" opacity="0.92"/>
    <circle cx="38" cy="66" r="10" fill="#444" opacity="0.9"/>
    <circle cx="78" cy="62" r="6" fill="#fff" opacity="0.9"/>
  </svg>`,
  P: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <rect x="32" y="30" width="56" height="70" rx="10" fill="#111" opacity="0.92"/>
    <rect x="40" y="42" width="40" height="6" rx="3" fill="#fff" opacity="0.9"/>
    <rect x="40" y="56" width="30" height="6" rx="3" fill="#fff" opacity="0.75"/>
    <rect x="40" y="70" width="36" height="6" rx="3" fill="#fff" opacity="0.75"/>
    <path d="M38 90 L50 78" stroke="#fff" stroke-width="5" stroke-linecap="round"/>
    <path d="M50 78 L82 46" stroke="#fff" stroke-width="5" stroke-linecap="round"/>
  </svg>`,
  V: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M60 26 L74 52 L102 56 L80 74 L86 102 L60 88 L34 102 L40 74 L18 56 L46 52 Z"
          fill="#111" opacity="0.92"/>
    <circle cx="60" cy="62" r="10" fill="#fff" opacity="0.15"/>
  </svg>`,
  C: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M40 44 L30 34 L28 54 Z" fill="#111"/>
    <path d="M80 44 L90 34 L92 54 Z" fill="#111"/>
    <path d="M36 52 C36 38, 84 38, 84 52 C84 84, 36 84, 36 52 Z"
          fill="#111" opacity="0.92"/>
    <circle cx="50" cy="62" r="5" fill="#fff" opacity="0.85"/>
    <circle cx="70" cy="62" r="5" fill="#fff" opacity="0.85"/>
    <path d="M58 70 Q60 72 62 70" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round"/>
  </svg>`,
  D: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M34 52 C34 38, 86 38, 86 56 C86 90, 34 90, 34 56 Z"
          fill="#111" opacity="0.92"/>
    <path d="M36 52 L24 44 L26 66 Z" fill="#333"/>
    <path d="M84 54 L98 46 L96 70 Z" fill="#333"/>
    <circle cx="52" cy="64" r="5" fill="#fff" opacity="0.85"/>
    <circle cx="70" cy="64" r="5" fill="#fff" opacity="0.85"/>
    <path d="M56 74 Q60 80 64 74" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round"/>
  </svg>`,
  O: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <rect x="30" y="30" width="60" height="60" rx="14" fill="#111" opacity="0.92"/>
    <path d="M30 46 H90" stroke="#fff" stroke-width="4" opacity="0.5"/>
    <path d="M46 30 V90" stroke="#fff" stroke-width="4" opacity="0.5"/>
    <circle cx="76" cy="76" r="10" fill="#fff" opacity="0.15"/>
  </svg>`,
  F: `
  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <rect x="10" y="10" width="100" height="100" rx="24" fill="#fff"/>
    <path d="M24 70 C32 50, 46 46, 60 56 C74 66, 86 62, 96 44"
          stroke="#111" stroke-width="10" fill="none" stroke-linecap="round" opacity="0.92"/>
    <path d="M24 86 C38 72, 54 72, 70 80 C86 88, 96 82, 102 74"
          stroke="#333" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.6"/>
  </svg>`
};

function iconForKey(k){ return ICON_SVG[k] || ""; }

/** =========================
 *  é˜²äº‚æ”¹ sigï¼ˆSHA-256ï¼‰
 *  ========================= */

function canonicalString(code, paramsObj) {
  return `r=${code}&bt=${paramsObj.bt}&pv=${paramsObj.pv}&cd=${paramsObj.cd}&of=${paramsObj.of}&salt=${SIG_SALT}`;
}
async function sha256Hex(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}
async function makeSig(code, pairs) {
  const hex = await sha256Hex(canonicalString(code, pairs));
  return hex.slice(0, 16); // 64bits
}

/** =========================
 *  å°å·¥å…·
 *  ========================= */
function toast(text){
  const t = document.getElementById("toast");
  t.textContent = text;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast("å·²è¤‡è£½ âœ…");
  }catch(e){
    const ta=document.createElement("textarea");
    ta.value=text;document.body.appendChild(ta);ta.select();
    document.execCommand("copy");document.body.removeChild(ta);
    toast("å·²è¤‡è£½ âœ…");
  }
}
function showMsg(text){
  const msg = document.getElementById("msg");
  msg.style.display = "block";
  msg.textContent = text;
}
function hideMsg(){
  const msg = document.getElementById("msg");
  msg.style.display = "none";
  msg.textContent = "";
}
function encodePair(a,b){ return `${a}-${b}`; }
function decodePair(str){
  if (!/^\d-\d$/.test(str)) return null;
  const [a,b]=str.split("-").map(n=>parseInt(n,10));
  if ([a,b].some(n=>Number.isNaN(n)||n<0||n>5)) return null;
  if (a+b!==5) return null;
  if (a===b) return null;
  return {a,b};
}
function flipHint(aKey, aScore, bKey, bScore) {
  const diff = Math.abs(aScore - bScore);
  const need = Math.floor(diff / 2) + 1;
  const leader = aScore > bScore ? aKey : bKey;
  return `ç›®å‰ ${leader} é ˜å…ˆï½œå·® ${need} é¡Œç¿»ç›¤`;
}

/** =========================
 *  UI Render
 *  ========================= */

function renderQuiz(){
  const root = document.getElementById("quiz");
  root.innerHTML = "";

  dims.forEach((d, dimIndex)=>{
    const sec=document.createElement("div");
    sec.className="section";
    sec.innerHTML = `
      <div class="section-title">ğŸ§© ${d.name}</div>
      <div class="small">ï¼ˆæ­¤æ§‹é¢ï¼š${d.keyA} vs ${d.keyB}ï¼Œå…± 5 é¡Œï¼›ä¸æœƒå¹³æ‰‹ï¼‰</div>
    `;
    root.appendChild(sec);

    questions.map((q,idx)=>({q,idx}))
      .filter(x=>x.q.dimIndex===dimIndex)
      .forEach(({q,idx})=>{
        const qId = `q${idx}`;
        const div=document.createElement("div");
        div.className="q";
        div.id = `card-${idx}`;
        div.innerHTML = `
          <h3>${q.text}</h3>

          <div class="opt-cards">
            <div class="opt-card" data-q="${idx}" data-opt="A">
              <div class="opt-ill">${iconForKey(q.aKey)}</div>
              <div class="opt-meta">
                <div class="opt-badge">A</div>
                <div class="opt-text">${q.aText}</div>
              </div>
              <label class="opt-pick">
                <input type="radio" name="${qId}" value="A" />
                æˆ‘é¸é€™å€‹
              </label>
            </div>

            <div class="opt-card" data-q="${idx}" data-opt="B">
              <div class="opt-ill">${iconForKey(q.bKey)}</div>
              <div class="opt-meta">
                <div class="opt-badge">B</div>
                <div class="opt-text">${q.bText}</div>
              </div>
              <label class="opt-pick">
                <input type="radio" name="${qId}" value="B" />
                æˆ‘é¸é€™å€‹
              </label>
            </div>
          </div>

          <div class="small">é¸ A â†’ ${q.aKey} +1 ï½œ é¸ B â†’ ${q.bKey} +1</div>
        `;
        root.appendChild(div);
      });
  });
}

function getAnswers(){
  return questions.map((_,i)=>document.querySelector(`input[name="q${i}"]:checked`)?.value||null);
}

function updateSelectedUI(qIndex){
  const cards = document.querySelectorAll(`.opt-card[data-q="${qIndex}"]`);
  cards.forEach(c=>c.classList.remove("selected"));
  const checked = document.querySelector(`input[name="q${qIndex}"]:checked`);
  if (!checked) return;
  const chosen = document.querySelector(`.opt-card[data-q="${qIndex}"][data-opt="${checked.value}"]`);
  if (chosen) chosen.classList.add("selected");
}

function refreshAllSelectedUI(){
  questions.forEach((_,i)=>updateSelectedUI(i));
}

/** =========================
 *  é€²åº¦ / å°èˆª
 *  ========================= */
function answeredCount(){
  return getAnswers().filter(Boolean).length;
}
function updateProgressUI(){
  const done = answeredCount();
  const pct = Math.round((done / questions.length) * 100);
  document.getElementById("progressFill").style.width = `${pct}%`;
  document.getElementById("progressText").textContent = `${done} / ${questions.length}`;
  document.getElementById("navMid").textContent =
    done === questions.length ? "å·²å®Œæˆæ‰€æœ‰é¡Œç›® âœ… å¯ä»¥è¨ˆç®—çµæœäº†" : `ç›®å‰å®Œæˆ ${done}/20ï¼ˆé»å¡ç‰‡ä½œç­”ï¼‰`;
}

function firstUnansweredIndex(){
  const ans = getAnswers();
  return ans.findIndex(v=>!v);
}
function currentFocusIndex(){
  // ç”¨ç›®å‰ viewport æœ€é ä¸Šçš„é¡Œç›®å¡æ¨ç®—ã€Œç›®å‰é¡Œã€
  const offsets = questions.map((_,i)=>{
    const el = document.getElementById(`card-${i}`);
    if (!el) return {i, top: 1e9};
    const r = el.getBoundingClientRect();
    return {i, top: Math.abs(r.top - 140)};
  });
  offsets.sort((a,b)=>a.top-b.top);
  return offsets[0]?.i ?? 0;
}
function scrollToQuestion(i){
  const el = document.getElementById(`card-${i}`);
  if (!el) return;
  el.scrollIntoView({behavior:"smooth", block:"start"});
}

/** =========================
 *  è¨ˆç®— / é¡¯ç¤º / åˆ†äº«
 *  ========================= */

function computeFromAnswers(answers){
  const score = { B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0 };

  answers.forEach((ans,i)=>{
    const q = questions[i];
    const key = (ans==="A") ? q.aKey : q.bKey;
    score[key] += 1;
  });

  const letters = dims.map(d => (score[d.keyA] > score[d.keyB]) ? d.keyA : d.keyB);
  const code = letters.join("");

  const pairs = {};
  dims.forEach(d => pairs[d.param] = encodePair(score[d.keyA], score[d.keyB]));
  return {score, code, pairs};
}

async function setShareParamsWithSig({code, pairs}){
  const sig = await makeSig(code, pairs);
  const url = new URL(window.location.href);
  url.searchParams.set("r", code);
  dims.forEach(d=>url.searchParams.set(d.param, pairs[d.param]));
  url.searchParams.set("sig", sig);
  window.history.replaceState({}, "", url.toString());
}

function renderResult({score, code}){
  const info = typeMap[code] || { title: "æœªå®šç¾©çµæœ", trait: ["è«‹è£œä¸Š typeMap å°ç…§"], quote:"" };

  document.getElementById("code").textContent = code;
  document.getElementById("typeTitle").textContent = info.title;

  const traitHTML = Array.isArray(info.trait)
    ? `<ul>${info.trait.map(t=>`<li>${t}</li>`).join("")}</ul>`
    : `<div>${info.trait}</div>`;
  document.getElementById("typeTrait").innerHTML = traitHTML;
  document.getElementById("typeQuote").textContent = info.quote || "";

  const scoresBox = document.getElementById("scores");
  scoresBox.innerHTML = "";
  dims.forEach(d=>{
    const a = score[d.keyA];
    const b = score[d.keyB];
    const winner = a>b ? d.keyA : d.keyB;

    const card = document.createElement("div");
    card.className = "score-line";
    card.innerHTML = `
      <div style="font-weight:900;">${d.name}</div>
      <div class="two" style="margin-top:6px;">
        <div>${d.keyA}ï¼š<span class="mono">${a}</span></div>
        <div>${d.keyB}ï¼š<span class="mono">${b}</span></div>
      </div>
      <div class="small" style="margin-top:6px;">
        çµæœï¼š<b>${winner}</b> ï½œ <span class="mono">${d.keyA} ${a} / ${d.keyB} ${b}</span> ï½œ ${flipHint(d.keyA, a, d.keyB, b)}
      </div>
      <div class="bar" title="${d.keyA} vs ${d.keyB}">
        <div style="width:${(a/5)*100}%"></div>
      </div>
      <div class="small">é•·æ¢ç‚º ${d.keyA} ä½”æ¯”ï¼ˆ0~5ï¼‰</div>
    `;
    scoresBox.appendChild(card);
  });

  document.getElementById("result").style.display = "block";
}

function buildResultCardText({score, code}){
  const info = typeMap[code] || { title:"æœªå®šç¾©çµæœ", trait:[], quote:"" };
  const url = window.location.href;

  const dimLines = dims.map(d=>{
    const a=score[d.keyA], b=score[d.keyB];
    const winner=a>b?d.keyA:d.keyB;
    return `- ${d.name}ï¼š${d.keyA} ${a} / ${d.keyB} ${b} â†’ ${winner}ï¼ˆ${flipHint(d.keyA,a,d.keyB,b)}ï¼‰`;
  }).join("\n");

  const traits = Array.isArray(info.trait) && info.trait.length
    ? info.trait.map(t=>`- ${t}`).join("\n")
    : "";

  return [
    `ã€ç¸é†« 16 å‹äººæ ¼æ¸¬é©—çµæœã€‘`,
    `å››å­—æ¯ï¼š${code}`,
    `${info.title}`,
    traits ? `\nç‰¹è³ªï¼š\n${traits}` : "",
    info.quote ? `\nä»£è¡¨å¥ï¼š${info.quote}` : "",
    `\næ§‹é¢åˆ†æ•¸ï¼š\n${dimLines}`,
    `\nåˆ†äº«é€£çµï¼ˆå«çœŸå¯¦åˆ†æ•¸+é©—è­‰ï¼‰ï¼š${url}`
  ].filter(Boolean).join("\n");
}

async function calcFromUI(){
  hideMsg();
  const answers = getAnswers();
  const missing = answers.map((v,i)=>v?null:i+1).filter(Boolean);
  if (missing.length){
    showMsg(`ä½ é‚„æœ‰ ${missing.length} é¡Œæœªä½œç­”ï¼šç¬¬ ${missing.join(", ")} é¡Œ`);
    const first = firstUnansweredIndex();
    if (first >= 0) scrollToQuestion(first);
    return;
  }

  const computed = computeFromAnswers(answers);
  await setShareParamsWithSig({code: computed.code, pairs: computed.pairs});
  renderResult({score: computed.score, code: computed.code});

  // çµ±è¨ˆï¼šé€å‡º + è®€å–ï¼ˆå¯é¸ï¼‰
  await maybeHandleStats(computed);

  document.getElementById("result").scrollIntoView({behavior:"smooth"});
}

function resetAll(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  refreshAllSelectedUI();
  updateProgressUI();
  hideMsg();

  document.getElementById("result").style.display="none";

  const url = new URL(window.location.href);
  ["r","sig",...dims.map(d=>d.param)].forEach(k=>url.searchParams.delete(k));
  window.history.replaceState({}, "", url.toString());

  document.getElementById("topHint").innerHTML =
    `ä½œç­”æ–¹å¼ï¼šæ¯é¡Œé¸ä¸€å€‹é¸é …ï¼›è©²é¸é …å°æ‡‰çš„å­—æ¯ +1ã€‚<br/>
     çµæœåˆ¤æ–·ï¼šæ¯å€‹æ§‹é¢å…± 5 é¡Œï¼Œæ‰€ä»¥ä¸æœƒå¹³æ‰‹ï¼›åˆ†æ•¸è¼ƒé«˜è€…æˆç‚ºè©²æ§‹é¢å­—æ¯ï¼Œçµ„æˆ 4 å­—æ¯å¾Œå°æ‡‰åˆ° 16 å‹ã€‚<br/>
     åˆ†äº«æ–¹å¼ï¼šç¶²å€æœƒå¸¶ä¸Š <span class="mono">r / bt / pv / cd / of / sig</span>ï¼ˆå«çœŸå¯¦åˆ†æ•¸ + é˜²æ‰‹æ”¹é©—è­‰ï¼‰ã€‚`;

  // éš±è—çµ±è¨ˆå€
  document.getElementById("statsBox").style.display="none";

  window.scrollTo({top:0,behavior:"smooth"});
}

/** =========================
 *  åˆ†äº«é€£çµè®€å–ï¼ˆå« sigï¼‰
 *  ========================= */

async function showResultFromParamsIfAny(){
  const url = new URL(window.location.href);
  const r = (url.searchParams.get("r")||"").toUpperCase().trim();
  if (!r) return;

  const codeOk = /^[BT][PV][CD][OF]$/.test(r) && typeMap[r];
  if (!codeOk) return;

  const sig = (url.searchParams.get("sig")||"").trim();
  if (!sig){
    showMsg("æ­¤åˆ†äº«é€£çµç¼ºå°‘é©—è­‰ç¢¼ï¼ˆsigï¼‰ï¼Œå¯èƒ½å·²è¢«ä¿®æ”¹æˆ–ç‰ˆæœ¬éèˆŠã€‚");
    return;
  }

  const pairs = {};
  const score = {B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0};

  for (const d of dims){
    const raw = (url.searchParams.get(d.param)||"").trim();
    const pair = decodePair(raw);
    if (!pair){
      showMsg("æ­¤åˆ†äº«é€£çµçš„åˆ†æ•¸åƒæ•¸ä¸å®Œæ•´æˆ–ä¸åˆæ³•ï¼ˆéœ€ç‚º 5 é¡Œåˆ¶ï¼Œä¾‹å¦‚ 4-1ï¼‰ã€‚");
      return;
    }
    pairs[d.param] = raw;
    score[d.keyA] = pair.a;
    score[d.keyB] = pair.b;

    // winner å¿…é ˆèˆ‡ r ä¸€è‡´
    const winner = (pair.a > pair.b) ? d.keyA : d.keyB;
    const expected = r[dims.indexOf(d)];
    if (winner !== expected){
      showMsg("åˆ†äº«é€£çµçš„ r èˆ‡åˆ†æ•¸å‹è² ä¸ä¸€è‡´ï¼Œå¯èƒ½è¢«æ‰‹å‹•ä¿®æ”¹ã€‚");
      return;
    }
  }

  const expectedSig = await makeSig(r, pairs);
  if (expectedSig !== sig){
    showMsg("æ­¤åˆ†äº«é€£çµå·²è¢«ä¿®æ”¹ï¼ˆsig é©—è­‰å¤±æ•—ï¼‰ã€‚è«‹é‡æ–°ç”¢ç”Ÿåˆ†äº«é€£çµã€‚");
    return;
  }

  document.getElementById("topHint").innerHTML =
    `ä½ æ­£åœ¨æŸ¥çœ‹åˆ†äº«çµæœï¼š<span class="mono">${r}</span>ï¼ˆæ­¤é€£çµåŒ…å«çœŸå¯¦åˆ†æ•¸ï¼Œä¸”å·²é€šéé©—è­‰ï¼‰`;

  renderResult({score, code: r});

  // çµ±è¨ˆï¼šåƒ…è®€å–ï¼ˆä¸é‡è¤‡é€å‡ºä¹Ÿå¯ï¼›é€™è£¡ä¿å®ˆï¼šä¸è‡ªå‹•é€å‡ºï¼‰
  await maybeLoadStatsOnly(r);

  document.getElementById("result").scrollIntoView({behavior:"smooth"});
}

/** =========================
 *  çµ±è¨ˆï¼ˆå¯é¸ï¼šGoogle Sheets / Apps Scriptï¼‰
 *  ========================= */

async function sendStats({code, pairs}){
  if (!STATS_ENDPOINT) return;
  try{
    await fetch(STATS_ENDPOINT, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        type: code,
        r: code,
        bt: pairs.bt, pv: pairs.pv, cd: pairs.cd, of: pairs.of,
        ua: navigator.userAgent
      })
    });
  }catch(e){}
}

async function loadStats(){
  if (!STATS_ENDPOINT) return null;
  try{
    const res = await fetch(STATS_ENDPOINT, {method:"GET"});
    const data = await res.json();
    return data?.counts ? data.counts : {};
  }catch(e){
    return null;
  }
}

function renderStatsUI(counts, myCode){
  if (!counts) return;
  const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((s, [,v])=>s+v, 0);
  const mine = counts[myCode] || 0;

  document.getElementById("statsBox").style.display = "block";
  document.getElementById("statsHint").textContent =
    STATS_ENDPOINT ? "ï¼ˆæ­¤çµ±è¨ˆç‚ºå…¨é«”ä½œç­”è€…å½™ç¸½ï¼Œåˆ·æ–°é é¢å¯æ›´æ–°ï¼‰" : "ï¼ˆæœªè¨­å®šçµ±è¨ˆç«¯é»ï¼‰";
  document.getElementById("statsTotal").textContent = total ? `${total}` : "0";
  document.getElementById("statsMine").textContent = `${myCode}ï¼š${mine}`;

  const rankBox = document.getElementById("statsRank");
  rankBox.innerHTML = `<div style="font-weight:900;margin-bottom:6px;">æ’è¡Œæ¦œï¼ˆå‰ 8ï¼‰</div>`;
  const top = entries.slice(0,8);
  if (!top.length){
    rankBox.innerHTML += `<div class="small">å°šç„¡è³‡æ–™</div>`;
    return;
  }
  top.forEach(([k,v],i)=>{
    const row = document.createElement("div");
    row.className = "rank-item";
    row.innerHTML = `<div>${i+1}. <span class="mono">${k}</span></div><div><b>${v}</b></div>`;
    rankBox.appendChild(row);
  });
}

async function maybeHandleStats(computed){
  if (!STATS_ENDPOINT) return;
  await sendStats({code: computed.code, pairs: computed.pairs});
  const counts = await loadStats();
  if (counts) renderStatsUI(counts, computed.code);
}

async function maybeLoadStatsOnly(code){
  if (!STATS_ENDPOINT) return;
  const counts = await loadStats();
  if (counts) renderStatsUI(counts, code);
}

/** =========================
 *  äº‹ä»¶ï¼šé¸å¡ç‰‡ã€æ›´æ–° UI
 *  ========================= */

document.getElementById("quiz").addEventListener("click", (e)=>{
  const card = e.target.closest(".opt-card");
  if (!card) return;

  const qIndex = parseInt(card.dataset.q, 10);
  const opt = card.dataset.opt; // A / B
  const radio = card.querySelector(`input[type="radio"][value="${opt}"]`);
  if (radio){
    radio.checked = true;
    updateSelectedUI(qIndex);
    updateProgressUI();

    // é¸å®Œè‡ªå‹•å°åˆ°ä¸‹ä¸€é¡Œï¼ˆæ›´é †ï¼‰
    const next = qIndex + 1;
    if (next < questions.length){
      setTimeout(()=>scrollToQuestion(next), 120);
    }
  }
});

document.getElementById("btnCalc").addEventListener("click", calcFromUI);
document.getElementById("btnReset").addEventListener("click", resetAll);

document.getElementById("btnPrev").addEventListener("click", ()=>{
  const cur = currentFocusIndex();
  const prev = Math.max(0, cur - 1);
  scrollToQuestion(prev);
});
document.getElementById("btnNext").addEventListener("click", ()=>{
  const cur = currentFocusIndex();
  const next = Math.min(questions.length - 1, cur + 1);
  scrollToQuestion(next);
});

document.getElementById("btnCopyLink").addEventListener("click", ()=>{
  const url = new URL(window.location.href);
  const hasR = url.searchParams.get("r");
  const hasSig = url.searchParams.get("sig");
  if (!hasR || !hasSig){
    showMsg("è«‹å…ˆå®Œæˆ 20 é¡Œä¸¦æŒ‰ã€Œè¨ˆç®—çµæœã€ï¼Œæ‰æœƒç”¢ç”Ÿå¯åˆ†äº«çš„é€£çµï¼ˆå« sigï¼‰ã€‚");
    return;
  }
  copyText(window.location.href);
});

document.getElementById("btnCopyCard").addEventListener("click", async ()=>{
  hideMsg();
  const url = new URL(window.location.href);
  const r = (url.searchParams.get("r")||"").toUpperCase().trim();
  const sig = (url.searchParams.get("sig")||"").trim();

  // è‹¥ URL æœ‰å®Œæ•´åƒæ•¸ï¼šå…ˆé©— sig å†è¤‡è£½ï¼ˆé¿å…è¤‡è£½åˆ°è¢«æ”¹éçš„é€£çµï¼‰
  if (r && typeMap[r] && sig){
    const pairs = {};
    const score = {B:0,T:0,P:0,V:0,C:0,D:0,O:0,F:0};

    for (const d of dims){
      const raw = (url.searchParams.get(d.param)||"").trim();
      const pair = decodePair(raw);
      if (!pair){
        showMsg("ç›®å‰ç¶²å€ç¼ºå°‘å®Œæ•´åˆ†æ•¸åƒæ•¸ï¼Œè«‹é‡æ–°è¨ˆç®—çµæœå¾Œå†è¤‡è£½çµæœå¡ã€‚");
        return;
      }
      pairs[d.param] = raw;
      score[d.keyA] = pair.a;
      score[d.keyB] = pair.b;
    }

    const expectedSig = await makeSig(r, pairs);
    if (expectedSig !== sig){
      showMsg("ç›®å‰ç¶²å€çš„ sig é©—è­‰å¤±æ•—ï¼ˆå¯èƒ½è¢«æ”¹éï¼‰ã€‚è«‹é‡æ–°è¨ˆç®—çµæœç”¢ç”Ÿæ–°é€£çµã€‚");
      return;
    }

    copyText(buildResultCardText({score, code:r}));
    return;
  }

  // å¦å‰‡ï¼šç”¨ä½œç­”é‡ç®—
  const answers = getAnswers();
  if (answers.some(v=>!v)){
    showMsg("è¦è¤‡è£½çµæœå¡å‰ï¼Œè«‹å…ˆå®Œæˆ 20 é¡Œä¸¦è¨ˆç®—çµæœã€‚");
    return;
  }
  const computed = computeFromAnswers(answers);
  await setShareParamsWithSig({code: computed.code, pairs: computed.pairs});
  renderResult({score: computed.score, code: computed.code});
  await maybeHandleStats(computed);
  copyText(buildResultCardText({score: computed.score, code: computed.code}));
});

document.getElementById("btnBackToQuiz").addEventListener("click", ()=>{
  document.getElementById("result").style.display = "none";
  const first = firstUnansweredIndex();
  scrollToQuestion(first >= 0 ? first : 0);
});

/** =========================
 *  åˆå§‹åŒ–
 *  ========================= */

renderQuiz();
refreshAllSelectedUI();
updateProgressUI();
showResultFromParamsIfAny();
</script>
</body>
</html>

